<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estación Meteorológica Tapichalaca - CITIAB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #003366;
            --primary-dark: #001a33;
            --secondary: #0066a1;
            --light: #f8f9fa;
            --dark: #333;
            --content-color: #555;
            --station-color: #003366;
            --background: #f0f4f8;
            --card-bg: rgba(255, 255, 255, 0.97);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 14px;
            --gray-light: #e0e0e0;
            --gray-medium: #a0a0a0;
            --gray-dark: #707070;
            --logo-unl-height: 110px;
            --logo-citiab-height: 160px;
            --logo-jocotoco-height: 80px;
            --logo-joinforwater-height: 180px;
            --temp-color: #e74c3c;
            --hum-color: #0066a1;
            --prec-color: #003366;
            --rad-color: #f1c40f;
            --logo-belgium-height: 65px;
            --logo-flanders-height: 70px;
            --logo-protos-height: 70px;
            --logo-unj-height: 70px;
            --logo-nci-height: 70px;
            --logo-joinforwater-coop-height: 70px;
            --logo-jocotoco-coop-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--background);
            font-family: 'Source Sans 3', 'Segoe UI', sans-serif;
            color: var(--content-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #e0e8f0 0%, #f0f4f8 100%);
            padding: 0;
            font-size: 0.9rem;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 20px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .title-container {
            flex: 1;
            padding-right: 15px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }

        .subtitle {
            font-size: 0.95rem;
            color: var(--secondary);
            max-width: 500px;
            line-height: 1.5;
            font-weight: 400;
        }

        .logos-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3px;
            transition: all 0.3s ease;
        }

        .logo-container:hover {
            transform: translateY(-3px);
        }

        .logo {
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        #unl-logo {
            height: var(--logo-unl-height);
        }

        #citiab-logo {
            height: var(--logo-citiab-height);
        }

        #jocotoco-logo {
            height: var(--logo-jocotoco-height);
        }

        #joinforwater-logo {
            height: var(--logo-joinforwater-height);
        }

        .station-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .section-title-container {
            text-align: center;
            margin-bottom: 5px;
        }

        .section-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            position: relative;
            display: inline-block;
            padding-bottom: 6px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            border-radius: 2px;
            background: var(--station-color);
        }

        .station-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 18px;
            position: relative;
            overflow: hidden;
            border-top: 4px solid var(--station-color);
            transition: all 0.3s ease;
        }

        .station-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .station-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 12px;
            flex-shrink: 0;
            animation: float 6s ease-in-out infinite;
            background: rgba(0, 51, 102, 0.1);
            color: var(--station-color);
        }

        .station-info {
            flex: 1;
        }

        .station-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--primary);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-online {
            background: rgba(46, 204, 113, 0.15);
            color: #27ae60;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online .status-dot {
            background: #27ae60;
        }

        .data-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 6px;
            margin-bottom: 10px;
        }

        .card-dark {
            background: var(--card-bg);
            color: var(--dark);
            border-radius: var(--border-radius);
            padding: 6px;
            text-align: center;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 65px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .card-dark:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .card-dark .icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
            transition: transform 0.3s ease;
        }

        .card-dark[data-var="airTC"] .icon {
            color: var(--temp-color);
        }

        .card-dark[data-var="Rh"] .icon {
            color: var(--hum-color);
        }

        .card-dark[data-var="lluvia"] .icon {
            color: var(--prec-color);
        }

        .card-dark[data-var="slrw"] .icon {
            color: var(--rad-color);
        }

        .card-dark.active .icon {
            transform: scale(1.1);
        }

        .card-dark .main-value {
            font-size: 1.05rem;
            font-weight: 700;
            margin: 1px 0;
            color: var(--primary-dark);
        }

        .card-dark .card-label {
            font-size: 0.85rem;
            color: var(--secondary);
            margin-top: 1px;
            line-height: 1.2;
            font-weight: 500;
        }

        .card-dark .card-time {
            font-size: 0.75rem;
            color: var(--gray-medium);
            margin-top: 1px;
            font-weight: 500;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 8px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: height 0.3s ease;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .chart-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .time-indicator {
            font-size: 0.85rem;
            color: var(--secondary);
            text-align: right;
            margin-top: 3px;
            font-weight: 500;
        }

        .info-note {
            font-size: 0.8rem;
            color: var(--gray-medium);
            margin-top: 2px;
            font-weight: 500;
        }

        .date-selector-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(0, 51, 102, 0.05);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .date-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            min-width: 160px;
        }

        .date-warning {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 5px;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 0.9rem;
            display: none;
            font-weight: 500;
        }

        .date-warning.show {
            display: block;
        }

        .download-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 51, 102, 0.05);
            border-radius: 8px;
        }

        .download-control-group {
            display: flex;
            flex-direction: column;
            min-width: 160px;
        }

        .download-label {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 2px;
            font-size: 0.9rem;
        }

        .download-select {
            border-radius: 5px;
            border: 1px solid #d0d0d0;
            padding: 4px 7px;
            font-size: 0.9rem;
            background: white;
        }

        .chart-info-panel {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.85rem;
            flex-wrap: wrap;
            padding-top: 6px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chart-stat {
            padding: 5px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.03);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            min-width: 140px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin: 2px;
            transition: all 0.2s ease;
        }

        .chart-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .chart-stat.max {
            color: #e74c3c;
            border-left: 4px solid #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }

        .chart-stat.min {
            color: #0066a1;
            border-left: 4px solid #0066a1;
            background: rgba(0, 102, 161, 0.05);
        }

        .chart-stat.avg {
            color: #003366;
            border-left: 4px solid #003366;
            background: rgba(0, 51, 102, 0.05);
        }

        .chart-stat.total {
            color: #001a33;
            border-left: 4px solid #001a33;
            background: rgba(0, 26, 51, 0.05);
        }

        .stat-value {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .stat-date {
            font-size: 0.75rem;
            color: var(--gray-medium);
            white-space: nowrap;
            margin-left: 5px;
            font-weight: 500;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .chart-item {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .chart-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .chart-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chart-item-title {
            font-size: 1.0rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chart-item-title i {
            font-size: 1.2rem;
        }

        .chart-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
        }

        .chart-container {
            min-width: 550px;
        }

        .size-control {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .size-label {
            color: var(--secondary);
            white-space: nowrap;
            font-weight: 500;
        }

        .size-slider {
            flex: 1;
            max-width: 120px;
        }

        .chart-date-picker {
            padding: 4px 7px;
            font-size: 0.9rem;
            border-radius: 5px;
            border: 1px solid #d0d0d0;
            background: white;
            min-width: 130px;
        }

        .loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 4px 8px;
            border-radius: 5px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 100%;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 4px 8px;
            border-radius: 5px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 100%;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
            transform: translateY(-2px);
        }

        .refresh-all-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 4px 8px;
            border-radius: 5px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .refresh-all-btn:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
        }

        .back-to-stations {
            position: absolute;
            left: 10px;
            top: 10px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: var(--shadow);
            text-decoration: none;
        }

        .back-to-stations:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .footer {
            background: var(--primary-dark);
            color: var(--light);
            padding: 20px 15px 12px;
            border-radius: var(--border-radius);
            margin-top: 25px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .footer-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
        }

        .footer-description {
            color: #e0e0e0;
            line-height: 1.5;
            margin-bottom: 12px;
            font-size: 0.85rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .contact-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 0.8rem;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #e0e0e0;
        }

        .contact-icon {
            color: var(--secondary);
        }

        .copyright {
            text-align: center;
            padding-top: 12px;
            margin-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .credits {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 0.85rem;
            color: #a8dadc;
            font-style: italic;
        }

        /* ===== ANIMACIONES ===== */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes droplet {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(2px);
            }
        }

        @keyframes rain {

            0%,
            100% {
                transform: rotate(0);
            }

            25% {
                transform: rotate(3deg);
            }

            75% {
                transform: rotate(-3deg);
            }
        }

        @keyframes shine {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ===== SECCIÓN DE COOPERANTES ===== */
        .cooperantes-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.8s ease-out;
        }

        .cooperantes-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            padding-bottom: 8px;
        }

        .cooperantes-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--secondary);
            border-radius: 2px;
        }

        .cooperantes-logos {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .cooperante-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            transition: all 0.3s ease;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .cooperante-logo-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
            background: white;
        }

        .cooperante-logo {
            object-fit: contain;
            transition: all 0.3s ease;
            filter: grayscale(20%);
        }

        .cooperante-logo-container:hover .cooperante-logo {
            filter: grayscale(0%);
            transform: scale(1.05);
        }

        #belgium-logo {
            height: var(--logo-belgium-height);
        }

        #flanders-logo {
            height: var(--logo-flanders-height);
        }

        #protos-logo {
            height: var(--logo-protos-height);
        }

        #unj-logo {
            height: var(--logo-unj-height);
            width: 180px;
            /* Ancho fijo para mantener proporción */
            object-fit: contain;
            /* Asegura que mantenga proporciones */
        }

        #nci-logo {
            height: var(--logo-nci-height);
        }

        #joinforwater-coop-logo {
            height: var(--logo-joinforwater-coop-height);
        }

        #jocotoco-coop-logo {
            height: var(--logo-jocotoco-coop-height);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ajuste del contenedor de logos para pantallas grandes */
        @media (min-width: 1200px) {
            .cooperantes-logos {
                gap: 20px;
                /* Más espacio entre logos */
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1100px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .header-section {
                flex-direction: column;
                padding: 15px 0;
                gap: 15px;
                text-align: center;
            }

            .title-container {
                padding-right: 0;
                padding: 0 15px;
            }

            .logos-container {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 15px;
            }

            :root {
                --logo-unl-height: 80px;
                --logo-citiab-height: 120px;
                --logo-jocotoco-height: 100px;
                --logo-joinforwater-height: 90px;
                --logo-belgium-height: 60px;
                --logo-flanders-height: 60px;
                --logo-protos-height: 60px;
                --logo-unj-height: 60px;
                --logo-nci-height: 60px;
                --logo-joinforwater-coop-height: 60px;
                --logo-jocotoco-coop-height: 60px;
            }

            .date-selector {
                flex-direction: column;
            }

            .chart-controls {
                flex-wrap: wrap;
            }

            .cooperantes-logos {
                gap: 12px;
            }

            #unj-logo {
                width: 140px;
                /* Ajuste para móviles */
            }
        }

        @media (max-width: 768px) {
            .chart-item-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .chart-info-panel {
                flex-direction: column;
                gap: 5px;
            }

            .chart-container {
                min-width: 100%;
            }

            .back-to-stations {
                position: relative;
                left: 0;
                top: 0;
                margin-bottom: 10px;
                width: 100%;
            }

            .cooperantes-logos {
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            .section-title {
                font-size: 1.4rem;
            }

            .card-dark {
                min-height: 60px;
            }

            .size-slider {
                max-width: 80px;
            }

            :root {
                --logo-unl-height: 70px;
                --logo-citiab-height: 100px;
                --logo-jocotoco-height: 85px;
                --logo-joinforwater-height: 80px;
                --logo-belgium-height: 50px;
                --logo-flanders-height: 50px;
                --logo-protos-height: 50px;
                --logo-unj-height: 50px;
                --logo-nci-height: 50px;
                --logo-joinforwater-coop-height: 50px;
                --logo-jocotoco-coop-height: 50px;
            }

            .cooperantes-logos {
                gap: 8px;
            }

            #unj-logo {
                width: 120px;
                /* Ajuste para móviles pequeños */
            }
        }
    </style>
</head>

<body>
    <!-- Botón para volver a la pantalla principal -->
    <a href="https://estaciones-citiab.vercel.app/" class="back-to-stations">
        <i class="fas fa-arrow-left"></i> Volver a Visor
    </a>

    <div class="app-container">
        <header class="header-section">
            <div class="title-container">
                <h1>Estación Meteorológica Tapichalaca</h1>
                <div class="subtitle">Reserva Tapichalaca, Zamora Chinchipe, Ecuador<br>Estación de monitoreo ambiental
                    CITIAB</div>
            </div>

            <div class="logos-container">
                <div class="logo-container">
                    <img src="https://joinforwater.ngo/wp-content/uploads/2022/05/logo-unl-HC-01-e1651758359420.png"
                        class="logo" alt="Logo UNL" id="unl-logo">
                </div>
                <div class="logo-container">
                    <img src="https://unl.edu.ec/sites/default/files/inline-images/logo%20citiab%202%20%281%29.png"
                        class="logo" alt="Logo CITIAB" id="citiab-logo">
                </div>
                <div class="logo-container">
                    <img src="https://i.ibb.co/6cpH5wWs/Whats-App-Image-2025-07-14-at-3-46-22-PM-removebg-preview-1.png"
                        class="logo" alt="Join For Water" id="joinforwater-logo">
                </div>
                <div class="logo-container">
                    <img src="https://i.ibb.co/M5yd0kZJ/472789761-1105565828029024-3870823381710171305-n-1.jpg"
                        class="logo" alt="Fundación Jocotoco" id="jocotoco-logo">
                </div>
            </div>
        </header>

        <section class="station-section">
            <div class="section-title-container">
                <h2 class="section-title">Monitoreo en Tiempo Real</h2>
            </div>

            <div class="station-card">
                <div class="card-header">
                    <div class="station-icon">
                        <i class="fas fa-cloud-sun"></i>
                    </div>
                    <div class="station-info">
                        <h3 class="station-name">Datos Actuales</h3>
                        <div class="status-indicator status-online">
                            <span class="status-dot"></span>
                            En línea - Datos actualizados
                        </div>
                    </div>
                </div>

                <div class="data-cards">
                    <div class="card-dark active" data-var="airTC">
                        <i class="fas fa-thermometer-half icon"></i>
                        <div class="main-value">--°C</div>
                        <div class="card-label">Temperatura del Aire</div>
                        <div class="card-time">--:--</div>
                    </div>

                    <div class="card-dark" data-var="Rh">
                        <i class="fas fa-tint icon"></i>
                        <div class="main-value">--%</div>
                        <div class="card-label">Humedad Relativa</div>
                        <div class="card-time">--:--</div>
                    </div>

                    <div class="card-dark" data-var="lluvia">
                        <i class="fas fa-cloud-rain icon"></i>
                        <div class="main-value">-- mm</div>
                        <div class="card-label">Precipitación</div>
                        <div class="card-time">--:--</div>
                    </div>

                    <div class="card-dark" data-var="slrw">
                        <i class="fas fa-sun icon"></i>
                        <div class="main-value">-- W/m²</div>
                        <div class="card-label">Radiación Solar</div>
                        <div class="card-time">--:--</div>
                    </div>
                </div>

                <div class="header-section">
                    <div></div>
                    <button class="refresh-all-btn" id="refreshAllBtn">
                        <i class="fas fa-sync-alt"></i> Actualizar Todo
                    </button>
                </div>

                <div class="date-selector-container">
                    <div class="date-selector">
                        <div class="date-input-group">
                            <label for="startDate" class="download-label">Fecha de inicio:</label>
                            <input type="date" id="startDate" class="download-select" min="2025-07-09" />
                        </div>

                        <div class="date-input-group">
                            <label for="endDate" class="download-label">Fecha de fin:</label>
                            <input type="date" id="endDate" class="download-select" min="2025-07-09" />
                        </div>

                        <div class="download-control-group">
                            <label class="download-label">Intervalo para descarga:</label>
                            <select id="downloadIntervalSelect" class="download-select">
                                <option value="1min">1 minuto (datos crudos)</option>
                                <option value="5min">5 minutos</option>
                                <option value="15min">15 minutos</option>
                                <option value="30min">30 minutos</option>
                                <option value="60min">60 minutos</option>
                                <option value="daily">Diario</option>
                            </select>
                        </div>

                        <div class="download-control-group">
                            <label class="download-label">Formato de archivo:</label>
                            <select id="fileFormatSelect" class="download-select">
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="csv">CSV (.csv)</option>
                            </select>
                        </div>

                        <div class="d-flex align-items-end mt-2">
                            <button class="btn btn-success" id="downloadRangeBtn">
                                <i class="fas fa-download"></i> Descargar datos
                            </button>
                        </div>
                    </div>

                    <div class="info-note">*Datos disponibles desde 9 julio 2025</div>
                    <div class="date-warning" id="dateWarning">
                        <strong>Nota:</strong> Para obtener todos los datos del rango seleccionado, asegúrese de
                        seleccionar fechas válidas. El sistema descargará automáticamente todas las mediciones
                        disponibles para el período
                        seleccionado.
                    </div>
                </div>

                <div class="chart-header">
                    <div class="chart-title">Datos Históricos</div>
                    <div class="chart-controls">
                        <div class="chart-control-group">
                            <span class="chart-control-label">
                                <i class="fas fa-calendar"></i> Seleccione fecha:
                            </span>
                            <input type="date" id="chartDatePicker" class="chart-date-picker" />
                        </div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-item">
                        <div class="chart-item-header">
                            <div class="chart-item-title">
                                <i class="fas fa-thermometer-half" style="color: var(--temp-color);"></i>
                                Temperatura del Aire (°C) - Promedio horario
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-container" id="tempChartContainer" style="height: 250px;">
                                <canvas id="tempChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-info-panel">
                            <div class="chart-stat max">
                                <i class="fas fa-arrow-up"></i> Máx: <span id="maxValueTemp"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="maxDateTemp">--:--</span>
                            </div>
                            <div class="chart-stat min">
                                <i class="fas fa-arrow-down"></i> Mín: <span id="minValueTemp"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="minDateTemp">--:--</span>
                            </div>
                            <div class="chart-stat avg">
                                <i class="fas fa-minus"></i> Prom: <span id="avgValueTemp" class="stat-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-item">
                        <div class="chart-item-header">
                            <div class="chart-item-title">
                                <i class="fas fa-tint" style="color: var(--hum-color);"></i>
                                Humedad Relativa (%) - Promedio horario
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-container" id="humChartContainer" style="height: 250px;">
                                <canvas id="humChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-info-panel">
                            <div class="chart-stat max">
                                <i class="fas fa-arrow-up"></i> Máx: <span id="maxValueHum" class="stat-value">--</span>
                                <span class="stat-date" id="maxDateHum">--:--</span>
                            </div>
                            <div class="chart-stat min">
                                <i class="fas fa-arrow-down"></i> Mín: <span id="minValueHum"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="minDateHum">--:--</span>
                            </div>
                            <div class="chart-stat avg">
                                <i class="fas fa-minus"></i> Prom: <span id="avgValueHum" class="stat-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-item">
                        <div class="chart-item-header">
                            <div class="chart-item-title">
                                <i class="fas fa-cloud-rain" style="color: var(--prec-color);"></i>
                                Precipitación (mm) - Suma horaria
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-container" id="precChartContainer" style="height: 250px;">
                                <canvas id="precChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-info-panel">
                            <div class="chart-stat max">
                                <i class="fas fa-arrow-up"></i> Máx: <span id="maxValuePrec"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="maxDatePrec">--:--</span>
                            </div>
                            <div class="chart-stat min">
                                <i class="fas fa-arrow-down"></i> Mín: <span id="minValuePrec"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="minDatePrec">--:--</span>
                            </div>
                            <div class="chart-stat avg">
                                <i class="fas fa-minus"></i> Prom: <span id="avgValuePrec" class="stat-value">--</span>
                            </div>
                            <div class="chart-stat total">
                                <i class="fas fa-plus-circle"></i> Total: <span id="totalValuePrec"
                                    class="stat-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-item">
                        <div class="chart-item-header">
                            <div class="chart-item-title">
                                <i class="fas fa-sun" style="color: var(--rad-color);"></i>
                                Radiación Solar (W/m²) - Promedio horario
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-container" id="radChartContainer" style="height: 250px;">
                                <canvas id="radChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-info-panel">
                            <div class="chart-stat max">
                                <i class="fas fa-arrow-up"></i> Máx: <span id="maxValueRad" class="stat-value">--</span>
                                <span class="stat-date" id="maxDateRad">--:--</span>
                            </div>
                            <div class="chart-stat min">
                                <i class="fas fa-arrow-down"></i> Mín: <span id="minValueRad"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="minDateRad">--:--</span>
                            </div>
                            <div class="chart-stat avg">
                                <i class="fas fa-minus"></i> Prom: <span id="avgValueRad" class="stat-value">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN DE COOPERANTES -->
                <div class="cooperantes-section">
                    <div class="cooperantes-title">Con el apoyo de:</div>
                    <div class="cooperantes-logos">
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/7Bfkpg8/Belgium-CMYK.jpg" alt="Cooperación Belga"
                                class="cooperante-logo" id="belgium-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/23nDmtnm/Flanders-en-amarillo.png" alt="Flanders"
                                class="cooperante-logo" id="flanders-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/v6Kn8RLf/Join-For-Water-cmyk.png" alt="Join For Water"
                                class="cooperante-logo" id="joinforwater-coop-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/60TJW3t1/3-Protos-Andes.jpg" alt="Protos Andes"
                                class="cooperante-logo" id="protos-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/pjwV3RZb/logo-Jocotoco.png" alt="Fundación Jocotoco"
                                class="cooperante-logo" id="jocotoco-coop-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/cXYMw668/jaen-1.jpg" alt="Universidad Nacional de Jaén"
                                class="cooperante-logo" id="unj-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/3XrwLkr/NCI-Shaker-Original-Spanish-RGB.png" alt="NCI"
                                class="cooperante-logo" id="nci-logo">
                        </div>
                    </div>
                </div>

                <div class="time-indicator">Última actualización: --:--:--</div>
            </div>
        </section>

        <footer class="footer">
            <div class="footer-content">
                <h3 class="footer-title">Centro de Investigaciones Tropicales del Ambiente y Biodiversidad (CITIAB)</h3>
                <p class="footer-description">
                    Investigamos biodiversidad, restauración de paisajes, servicios ecosistémicos, hidrología y cambio
                    climático para contribuir al conocimiento científico y la conservación ambiental.
                </p>

                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-map-marker-alt contact-icon"></i>
                        <span>Ciudad Universitaria Guillermo Falconí - Loja - Ecuador</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-phone contact-icon"></i>
                        <span>07 2593550</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-envelope contact-icon"></i>
                        <span>comunicacion@unl.edu.ec</span>
                    </div>
                </div>

                <div class="credits">
                    Desarrollado por el Ing. Kevin David Loja Sarmiento en colaboración del Mgs. Juan Dario Quinde y el
                    Centro de Investigación CITIAB
                </div>

                <div class="copyright">
                    &copy; 2025 CITIAB - Universidad Nacional de Loja. Todos los derechos reservados.
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabase = createClient(
            'https://ecuossvqnlodykbgemqh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjdW9zc3ZxbmxvZHlrYmdlbXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NDQzMDMsImV4cCI6MjA2NTMyMDMwM30.aCVFkPpjdf2KR4M8Qjd3JT_ieuIG5YMtM-2UmBxKYBQ'
        );
        const TABLE_NAME = 'tapichalaca';

        // Función para crear fecha en zona horaria local
        function createLocalDate(year, month, day) {
            return new Date(year, month - 1, day);
        }

        // Función para formatear fecha a YYYY-MM-DD en zona local
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Función para mostrar fecha en formato local
        function displayLocalDate(date) {
            return date.toLocaleDateString('es-EC', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // FUNCIÓN PARA FORMATEAR TIEMPO SIN CAMBIAR ZONA HORARIA
        function formatUTCTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (isNaN(date)) return isoString;

            // Obtener componentes UTC sin conversión
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const seconds = String(date.getUTCSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        const variableColors = {
            airTC: '#e74c3c',
            lluvia: '#003366',
            Rh: '#0066a1',
            slrw: '#f1c40f'
        };

        const variableMeta = {
            airTC: {
                label: "Temperatura del Aire",
                unit: "°C",
                icon: "fa-thermometer-half",
                color: variableColors.airTC
            },
            lluvia: {
                label: "Precipitación",
                unit: "mm",
                icon: "fa-cloud-rain",
                color: variableColors.lluvia
            },
            Rh: {
                label: "Humedad Relativa",
                unit: "%",
                icon: "fa-tint",
                color: variableColors.Rh
            },
            slrw: {
                label: "Radiación Solar",
                unit: "W/m²",
                icon: "fa-sun",
                color: variableColors.slrw
            }
        };

        // Crear las 4 gráficas
        const tempCtx = document.getElementById('tempChart').getContext('2d');
        const humCtx = document.getElementById('humChart').getContext('2d');
        const precCtx = document.getElementById('precChart').getContext('2d');
        const radCtx = document.getElementById('radChart').getContext('2d');

        // Función para crear gráficas con ejes horarios
        function createChart(ctx, color, label) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(24).fill().map((_, i) => `${i.toString().padStart(2, '0')}:00`),
                    datasets: [{
                        label: label,
                        data: Array(24).fill(null),
                        borderColor: color,
                        backgroundColor: color + '33',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        fill: false,
                        tension: 0.3,
                        cubicInterpolationMode: 'monotone'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#003366',
                            bodyColor: '#003366',
                            borderColor: 'rgba(0, 0, 0, 0.05)',
                            borderWidth: 1,
                            padding: 7,
                            displayColors: true,
                            callbacks: {
                                title: function (tooltipItems) {
                                    return tooltipItems[0].label;
                                },
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.parsed.y !== null ? context.parsed.y.toFixed(2) : 'N/A'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.03)'
                            },
                            title: {
                                display: true,
                                text: 'Hora del día',
                                color: '#003366',
                                font: { weight: 'bold', size: 11 }
                            },
                            ticks: {
                                color: '#003366',
                                font: { weight: 'bold', size: 9 },
                                maxRotation: 0,
                                minRotation: 0,
                                padding: 5,
                                callback: function (value, index) {
                                    return value;
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.03)',
                                borderDash: [4, 4]
                            },
                            title: {
                                display: true,
                                text: 'Valor',
                                color: '#003366',
                                font: { weight: 'bold', size: 11 }
                            },
                            ticks: {
                                color: '#003366',
                                font: { weight: 'bold', size: 9 },
                                padding: 4,
                                callback: function (value) {
                                    return value;
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    },
                    layout: {
                        padding: {
                            bottom: 10,
                            left: 3,
                            right: 3
                        }
                    }
                }
            });
        }

        const tempChart = createChart(tempCtx, variableColors.airTC, 'Temperatura del Aire (°C)');
        const humChart = createChart(humCtx, variableColors.Rh, 'Humedad Relativa (%)');
        const precChart = createChart(precCtx, variableColors.lluvia, 'Precipitación (mm)');
        const radChart = createChart(radCtx, variableColors.slrw, 'Radiación Solar (W/m²)');

        let chartData = [];
        let selectedDate = new Date();
        selectedDate.setHours(0, 0, 0, 0); // Fecha predeterminada: hoy

        // Actualizar título de la gráfica
        function updateChartTitle() {
            const dateStr = displayLocalDate(selectedDate);
            document.querySelector('.chart-title').textContent = `Datos del día: ${dateStr}`;
        }

        // Actualizar tarjetas de datos
        async function updateDataCards() {
            try {
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    .order('tiempo', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const latestData = data[0];
                    console.log('Datos recibidos:', latestData);

                    document.querySelector('.card-dark[data-var="airTC"] .main-value').textContent = latestData.airTC.toFixed(2) + "°C";
                    document.querySelector('.card-dark[data-var="Rh"] .main-value').textContent = latestData.Rh.toFixed(2) + "%";
                    document.querySelector('.card-dark[data-var="lluvia"] .main-value').textContent = latestData.lluvia.toFixed(2) + " mm";
                    document.querySelector('.card-dark[data-var="slrw"] .main-value').textContent = latestData.slrw.toFixed(2) + " W/m²";

                    document.querySelectorAll('.card-time').forEach(el => {
                        el.textContent = latestData.hora ? latestData.hora.substring(0, 5) : '--:--';
                    });

                    updateIconAnimations(latestData);

                    const now = new Date();
                    document.querySelector('.time-indicator').textContent =
                        `Última actualización: ${now.toLocaleTimeString('es-EC')}`;
                }
            } catch (error) {
                console.error('Error al obtener datos:', error);
            }
        }

        // Actualizar animaciones de íconos
        function updateIconAnimations(data) {
            const tempIcon = document.querySelector('.card-dark[data-var="airTC"] .icon');
            const tempSpeed = 2 - (data.airTC / 40);
            tempIcon.style.animation = `pulse ${Math.max(0.5, Math.min(2, tempSpeed))}s infinite`;

            const humIcon = document.querySelector('.card-dark[data-var="Rh"] .icon');
            const humSpeed = 3 - (data.Rh / 50);
            humIcon.style.animation = `droplet ${Math.max(1, Math.min(3, humSpeed))}s infinite`;

            const precIcon = document.querySelector('.card-dark[data-var="lluvia"] .icon');
            let precSpeed = 3;
            if (data.lluvia > 0) {
                precSpeed = 3 - (data.lluvia / 5);
                precIcon.style.animation = `rain ${Math.max(0.8, Math.min(3, precSpeed))}s infinite`;
            }

            const radIcon = document.querySelector('.card-dark[data-var="slrw"] .icon');
            const radSpeed = 3 - (data.slrw / 500);
            radIcon.style.animation = `shine ${Math.max(1, Math.min(3, radSpeed))}s infinite`;
        }

        // Función para calcular promedios y sumas horarias
        function processHourlyData(data) {
            // Crear arrays para cada hora (0-23)
            const hourlyBuckets = Array(24).fill().map(() => ({
                airTC: [],
                Rh: [],
                lluvia: [],
                slrw: []
            }));

            // Agrupar datos por hora
            data.forEach(record => {
                const hour = parseInt(record.hora.split(':')[0]);
                if (hour >= 0 && hour <= 23) {
                    hourlyBuckets[hour].airTC.push(record.airTC);
                    hourlyBuckets[hour].Rh.push(record.Rh);
                    hourlyBuckets[hour].lluvia.push(record.lluvia);
                    hourlyBuckets[hour].slrw.push(record.slrw);
                }
            });

            // Calcular promedios y sumas
            const result = {
                airTC: Array(24).fill(null),
                Rh: Array(24).fill(null),
                lluvia: Array(24).fill(null),
                slrw: Array(24).fill(null)
            };

            hourlyBuckets.forEach((bucket, hour) => {
                if (bucket.airTC.length > 0) {
                    // Temperatura: promedio
                    result.airTC[hour] = bucket.airTC.reduce((a, b) => a + b, 0) / bucket.airTC.length;
                }

                if (bucket.Rh.length > 0) {
                    // Humedad: promedio
                    result.Rh[hour] = bucket.Rh.reduce((a, b) => a + b, 0) / bucket.Rh.length;
                }

                if (bucket.lluvia.length > 0) {
                    // Precipitación: suma
                    result.lluvia[hour] = bucket.lluvia.reduce((a, b) => a + b, 0);
                }

                if (bucket.slrw.length > 0) {
                    // Radiación solar: promedio
                    result.slrw[hour] = bucket.slrw.reduce((a, b) => a + b, 0) / bucket.slrw.length;
                }
            });

            return result;
        }

        async function updateChart() {
            updateChartTitle();

            try {
                const offset = new Date().getTimezoneOffset(); // Ecuador = 300

                // --- RANGO 1: 00:00 a 11:59 ---
                const start1 = new Date(selectedDate);
                start1.setHours(0, 0, 0, 0);

                const end1 = new Date(selectedDate);
                end1.setHours(12, 0, 0, 0);

                // --- RANGO 2: 12:00 a 23:59 ---
                const start2 = new Date(selectedDate);
                start2.setHours(12, 0, 0, 0);

                const end2 = new Date(selectedDate);
                end2.setDate(end2.getDate() + 1); // día siguiente
                end2.setHours(0, 0, 0, 0);

                // Convertir todo a UTC
                const startUTC1 = new Date(start1.getTime() - offset * 60000);
                const endUTC1 = new Date(end1.getTime() - offset * 60000);
                const startUTC2 = new Date(start2.getTime() - offset * 60000);
                const endUTC2 = new Date(end2.getTime() - offset * 60000);

                // --- CONSULTA 1 ---
                const { data: data1, error: error1 } = await supabase
                    .from(TABLE_NAME)
                    .select('tiempo, fecha, hora, airTC, Rh, lluvia, slrw')
                    .gte('tiempo', startUTC1.toISOString())
                    .lt('tiempo', endUTC1.toISOString())
                    .order('tiempo', { ascending: true });

                if (error1) throw error1;

                // --- CONSULTA 2 ---
                const { data: data2, error: error2 } = await supabase
                    .from(TABLE_NAME)
                    .select('tiempo, fecha, hora, airTC, Rh, lluvia, slrw')
                    .gte('tiempo', startUTC2.toISOString())
                    .lt('tiempo', endUTC2.toISOString())
                    .order('tiempo', { ascending: true });

                if (error2) throw error2;

                // Unir resultados
                const allData = [...(data1 || []), ...(data2 || [])];

                // Procesar datos por hora
                const processedData = processHourlyData(allData);

                // Actualizar gráficas
                tempChart.data.datasets[0].data = processedData.airTC;
                humChart.data.datasets[0].data = processedData.Rh;
                precChart.data.datasets[0].data = processedData.lluvia;
                radChart.data.datasets[0].data = processedData.slrw;

                tempChart.update();
                humChart.update();
                precChart.update();
                radChart.update();

                // Actualizar estadísticas
                updateChartStats(processedData);

                // Hora de actualización
                const now = new Date();
                document.querySelector('.time-indicator').textContent =
                    `Última actualización: ${now.toLocaleTimeString('es-EC')}`;

            } catch (error) {
                console.error('Error al actualizar gráfico:', error);
            }
        }

        // Función para actualizar estadísticas
        function updateChartStats(processedData) {
            // Temperatura
            const tempValues = processedData.airTC.filter(val => val !== null);
            if (tempValues.length > 0) {
                const maxTemp = Math.max(...tempValues);
                const minTemp = Math.min(...tempValues);
                const avgTemp = tempValues.reduce((a, b) => a + b, 0) / tempValues.length;

                document.getElementById('maxValueTemp').textContent = maxTemp.toFixed(2);
                document.getElementById('minValueTemp').textContent = minTemp.toFixed(2);
                document.getElementById('avgValueTemp').textContent = avgTemp.toFixed(2);

                const maxTempHour = processedData.airTC.indexOf(maxTemp);
                const minTempHour = processedData.airTC.indexOf(minTemp);
                document.getElementById('maxDateTemp').textContent = `${maxTempHour.toString().padStart(2, '0')}:00`;
                document.getElementById('minDateTemp').textContent = `${minTempHour.toString().padStart(2, '0')}:00`;
            }

            // Humedad
            const humValues = processedData.Rh.filter(val => val !== null);
            if (humValues.length > 0) {
                const maxHum = Math.max(...humValues);
                const minHum = Math.min(...humValues);
                const avgHum = humValues.reduce((a, b) => a + b, 0) / humValues.length;

                document.getElementById('maxValueHum').textContent = maxHum.toFixed(2);
                document.getElementById('minValueHum').textContent = minHum.toFixed(2);
                document.getElementById('avgValueHum').textContent = avgHum.toFixed(2);

                const maxHumHour = processedData.Rh.indexOf(maxHum);
                const minHumHour = processedData.Rh.indexOf(minHum);
                document.getElementById('maxDateHum').textContent = `${maxHumHour.toString().padStart(2, '0')}:00`;
                document.getElementById('minDateHum').textContent = `${minHumHour.toString().padStart(2, '0')}:00`;
            }

            // Precipitación
            const precValues = processedData.lluvia.filter(val => val !== null);
            if (precValues.length > 0) {
                const maxPrec = Math.max(...precValues);
                const minPrec = Math.min(...precValues);
                const totalPrec = precValues.reduce((a, b) => a + b, 0);
                const avgPrec = totalPrec / precValues.length;

                document.getElementById('maxValuePrec').textContent = maxPrec.toFixed(2);
                document.getElementById('minValuePrec').textContent = minPrec.toFixed(2);
                document.getElementById('avgValuePrec').textContent = avgPrec.toFixed(2);
                document.getElementById('totalValuePrec').textContent = totalPrec.toFixed(2) + " mm";

                const maxPrecHour = processedData.lluvia.indexOf(maxPrec);
                const minPrecHour = processedData.lluvia.indexOf(minPrec);
                document.getElementById('maxDatePrec').textContent = `${maxPrecHour.toString().padStart(2, '0')}:00`;
                document.getElementById('minDatePrec').textContent = `${minPrecHour.toString().padStart(2, '0')}:00`;
            }

            // Radiación solar
            const radValues = processedData.slrw.filter(val => val !== null);
            if (radValues.length > 0) {
                const maxRad = Math.max(...radValues);
                const minRad = Math.min(...radValues);
                const avgRad = radValues.reduce((a, b) => a + b, 0) / radValues.length;

                document.getElementById('maxValueRad').textContent = maxRad.toFixed(2);
                document.getElementById('minValueRad').textContent = minRad.toFixed(2);
                document.getElementById('avgValueRad').textContent = avgRad.toFixed(2);

                const maxRadHour = processedData.slrw.indexOf(maxRad);
                const minRadHour = processedData.slrw.indexOf(minRad);
                document.getElementById('maxDateRad').textContent = `${maxRadHour.toString().padStart(2, '0')}:00`;
                document.getElementById('minDateRad').textContent = `${minRadHour.toString().padStart(2, '0')}:00`;
            }
        }

        function updateSingleChart(chart, data) {
            chart.data.datasets[0].data = data;
            chart.update();
        }

        // Función para agrupar datos por intervalo exacto
        function groupDataByInterval(data, interval) {
            if (interval === '1min') return data;

            // Mapa para agrupar por tiempo redondeado
            const groupedData = {};

            data.forEach(record => {
                const date = new Date(record.tiempo);
                let roundedTime;

                if (interval === 'daily') {
                    // Agrupar por fecha directamente (sin hora)
                    roundedTime = record.fecha; // agrupación 100% confiable por campo fecha
                } else {
                    // Calcular minutos totales
                    const totalMinutes = date.getHours() * 60 + date.getMinutes();
                    let intervalMinutes;

                    switch (interval) {
                        case '5min': intervalMinutes = 5; break;
                        case '15min': intervalMinutes = 15; break;
                        case '30min': intervalMinutes = 30; break;
                        case '60min': intervalMinutes = 60; break;
                        default: intervalMinutes = 60;
                    }

                    // Redondear al intervalo más cercano (hacia abajo)
                    const roundedMinutes = Math.floor(totalMinutes / intervalMinutes) * intervalMinutes;
                    const roundedHours = Math.floor(roundedMinutes / 60);
                    const finalMinutes = roundedMinutes % 60;

                    roundedTime = new Date(
                        date.getFullYear(),
                        date.getMonth(),
                        date.getDate(),
                        roundedHours,
                        finalMinutes,
                        0,
                        0
                    ).toISOString();
                }

                if (!groupedData[roundedTime]) {
                    groupedData[roundedTime] = [];
                }
                groupedData[roundedTime].push(record);
            });

            // Procesar cada grupo
            const result = [];
            for (const time in groupedData) {
                const group = groupedData[time];
                const aggregated = aggregateGroup(group, interval);

                if (group.length > 0) {
                    // Usar el primer registro como base
                    const firstRecord = group[0];
                    result.push({
                        tiempo: time,
                        fecha: firstRecord.fecha,
                        hora: interval === 'daily' ? "00:00:00" : firstRecord.hora,  // FIX: Set 00:00:00 for daily
                        airTC: calculateAverage(group, 'airTC'),
                        lluvia: calculateSum(group, 'lluvia'),
                        Rh: calculateAverage(group, 'Rh'),
                        slrw: calculateAverage(group, 'slrw')
                    });
                }
            }

            return result;
        }

        // Función para agregar datos del grupo
        function aggregateGroup(group) {
            return {
                airTC: calculateAverage(group, 'airTC'),
                lluvia: calculateSum(group, 'lluvia'),
                Rh: calculateAverage(group, 'Rh'),
                slrw: calculateAverage(group, 'slrw')
            };
        }

        // Calcular promedio
        function calculateAverage(data, key) {
            const values = data.map(d => d[key]).filter(val => val !== null);
            return values.length ? (values.reduce((a, b) => a + b, 0) / values.length) : 0;
        }

        // Calcular suma
        function calculateSum(data, key) {
            return data.reduce((sum, d) => sum + (d[key] || 0), 0);
        }

        // FUNCIÓN PARA DESCARGAR DATOS POR RANGO DE FECHAS
        const downloadRangeData = async () => {
            const btn = document.getElementById('downloadRangeBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-sync-alt spin"></i> Procesando...';
            btn.disabled = true;

            const dateWarning = document.getElementById('dateWarning');
            dateWarning.classList.add('show');

            try {
                // Obtener fechas seleccionadas
                const startDateValue = document.getElementById('startDate').value;
                const endDateValue = document.getElementById('endDate').value;

                // Validar fechas
                if (!startDateValue || !endDateValue) {
                    throw new Error('Por favor seleccione ambas fechas');
                }

                if (startDateValue > endDateValue) {
                    throw new Error('La fecha de inicio no puede ser posterior a la fecha de fin');
                }

                // Validar que las fechas no sean futuras
                const today = new Date();
                const todayStr = formatLocalDate(today);

                if (startDateValue > todayStr || endDateValue > todayStr) {
                    throw new Error('No puede seleccionar fechas futuras');
                }

                // Validar que las fechas no sean anteriores al 9 de julio de 2025
                if (startDateValue < '2025-07-09' || endDateValue < '2025-07-09') {
                    throw new Error('No hay datos disponibles antes del 9 de julio de 2025');
                }

                // Obtener intervalo seleccionado para descarga
                const interval = document.getElementById('downloadIntervalSelect').value;
                const fileFormat = document.getElementById('fileFormatSelect').value;

                // Obtener todos los datos para el rango de fechas
                let allData = [];
                let page = 0;
                const pageSize = 1000;
                let hasMoreData = true;

                while (hasMoreData) {
                    const { data, error } = await supabase
                        .from(TABLE_NAME)
                        .select('tiempo, fecha, hora, airTC, lluvia, Rh, slrw')
                        .gte('fecha', startDateValue)
                        .lte('fecha', endDateValue)
                        .order('fecha', { ascending: true })
                        .order('hora', { ascending: true })
                        .range(page * pageSize, (page + 1) * pageSize - 1);

                    if (error) throw error;

                    if (!data || data.length === 0) break;

                    allData = [...allData, ...data];

                    if (data.length < pageSize) {
                        hasMoreData = false;
                    } else {
                        page++;
                    }
                }

                if (allData.length === 0) {
                    return alert('No hay datos disponibles para el rango seleccionado');
                }

                // Agrupar datos según el intervalo seleccionado
                let processedData;
                if (interval === '1min') {
                    processedData = allData;
                } else {
                    processedData = groupDataByInterval(allData, interval);
                }
                // INVERTIR EL ORDEN DE LOS DATOS (más reciente primero)
                processedData = processedData.reverse();
                // Preparar datos para exportación
                const headers = [
                    'Fecha Sensor', 'Hora Sensor',
                    'Temperatura (°C)', 'Precipitación (mm)', 'Humedad (%)', 'Radiación (W/m²)'
                ];

                const rows = processedData.map(d => [
                    d.fecha,
                    d.hora,
                    d.airTC ? d.airTC.toFixed(2) : '',
                    d.lluvia ? d.lluvia.toFixed(2) : '0.00',
                    d.Rh ? d.Rh.toFixed(2) : '',
                    d.slrw ? d.slrw.toFixed(2) : ''
                ]);

                // Crear hoja de cálculo
                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);

                // Formatear encabezados
                headers.forEach((header, index) => {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: index });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = { font: { bold: true } };
                    }
                });

                // Ajustar ancho de columnas
                ws['!cols'] = [
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 18 }
                ];

                // Crear y descargar archivo
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Datos Meteorológicos');

                // Nombre del archivo
                const fileName = `Datos_Meteorologicos_Tapichalaca_${startDateValue}_a_${endDateValue}_${interval}`;

                if (fileFormat === 'xlsx') {
                    XLSX.writeFile(wb, `${fileName}.xlsx`);
                } else {
                    // Exportar como CSV
                    const csv = XLSX.utils.sheet_to_csv(ws);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `${fileName}.csv`;
                    link.click();
                }

            } catch (error) {
                alert('Error al descargar: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                setTimeout(() => dateWarning.classList.remove('show'), 5000);
            }
        };

        // Event listeners
        document.getElementById('downloadRangeBtn').addEventListener('click', downloadRangeData);

        document.getElementById('refreshAllBtn').addEventListener('click', async () => {
            const btn = document.getElementById('refreshAllBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-sync-alt spin"></i> Actualizando...';

            try {
                await updateDataCards();
                await updateChart();
            } catch (error) {
                console.error('Error al actualizar todo:', error);
            } finally {
                btn.innerHTML = originalText;
            }
        });

        // Event listener para el selector de fecha de la gráfica
        document.getElementById('chartDatePicker').addEventListener('change', function () {
            const dateString = this.value;
            if (!dateString) return;

            const [year, month, day] = dateString.split('-').map(Number);
            selectedDate = new Date(year, month - 1, day);

            updateChart();
        });

        async function initApp() {
            // Inicializar fechas
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayStr = formatLocalDate(today);

            document.getElementById('startDate').value = '2025-07-09';
            document.getElementById('endDate').value = todayStr;
            document.getElementById('chartDatePicker').value = todayStr;

            document.getElementById('startDate').min = '2025-07-09';
            document.getElementById('startDate').max = todayStr;
            document.getElementById('endDate').min = '2025-07-09';
            document.getElementById('endDate').max = todayStr;
            document.getElementById('chartDatePicker').min = '2025-07-09';
            document.getElementById('chartDatePicker').max = todayStr;

            // Usar la fecha actual como predeterminada
            selectedDate = today;

            updateChartTitle();
            await updateDataCards();
            await updateChart();
            setInterval(updateDataCards, 60000);
            setInterval(updateChart, 300000);
        }

        initApp();

        const style = document.createElement('style');
        style.innerHTML = `
            .spin {
                animation: spin 1s linear infinite;
                display: inline-block;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>
