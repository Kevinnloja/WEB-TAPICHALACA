<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estación Meteorológica Tapichalaca - CITIAB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #003366;
            --primary-dark: #001a33;
            --secondary: #0066a1;
            --light: #f8f9fa;
            --dark: #333;
            --content-color: #555;
            --station-color: #003366;
            --background: #f0f4f8;
            --card-bg: rgba(255, 255, 255, 0.97);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 14px;
            --gray-light: #e0e0e0;
            --gray-medium: #a0a0a0;
            --gray-dark: #707070;
            --logo-unl-height: 110px;
            --logo-citiab-height: 160px;
            --logo-jocotoco-height: 80px;
            --logo-joinforwater-height: 180px;
            --temp-color: #e74c3c;
            --hum-color: #0066a1;
            --prec-color: #003366;
            --rad-color: #f1c40f;
            --logo-belgium-height: 65px;
            --logo-flanders-height: 70px;
            --logo-protos-height: 70px;
            --logo-unj-height: 70px;
            --logo-nci-height: 70px;
            --logo-joinforwater-coop-height: 70px;
            --logo-jocotoco-coop-height: 70px;
            --flag-size: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--background);
            font-family: 'Source Sans 3', 'Segoe UI', sans-serif;
            color: var(--content-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #e0e8f0 0%, #f0f4f8 100%);
            padding: 0;
            font-size: 0.9rem;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 20px;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .title-container {
            flex: 1;
            padding-right: 15px;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }

        .subtitle {
            font-size: 0.95rem;
            color: var(--secondary);
            max-width: 500px;
            line-height: 1.5;
            font-weight: 400;
        }

        .logos-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3px;
            transition: all 0.3s ease;
        }

        .logo-container:hover {
            transform: translateY(-3px);
        }

        .logo {
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        #unl-logo {
            height: var(--logo-unl-height);
        }

        #citiab-logo {
            height: var(--logo-citiab-height);
        }

        #jocotoco-logo {
            height: var(--logo-jocotoco-height);
        }

        #joinforwater-logo {
            height: var(--logo-joinforwater-height);
        }

        .station-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .section-title-container {
            text-align: center;
            margin-bottom: 5px;
        }

        .section-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            position: relative;
            display: inline-block;
            padding-bottom: 6px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            border-radius: 2px;
            background: var(--station-color);
        }

        .station-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 18px;
            position: relative;
            overflow: hidden;
            border-top: 4px solid var(--station-color);
            transition: all 0.3s ease;
        }

        .station-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .station-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 12px;
            flex-shrink: 0;
            animation: float 6s ease-in-out infinite;
            background: rgba(0, 51, 102, 0.1);
            color: var(--station-color);
        }

        .station-info {
            flex: 1;
        }

        .station-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--primary);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-online {
            background: rgba(46, 204, 113, 0.15);
            color: #27ae60;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online .status-dot {
            background: #27ae60;
        }

        .data-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 6px;
            margin-bottom: 10px;
        }

        .card-dark {
            background: var(--card-bg);
            color: var(--dark);
            border-radius: var(--border-radius);
            padding: 6px;
            text-align: center;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 65px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .card-dark:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .card-dark .icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
            transition: transform 0.3s ease;
        }

        .card-dark[data-var="airTC"] .icon {
            color: var(--temp-color);
        }

        .card-dark[data-var="Rh"] .icon {
            color: var(--hum-color);
        }

        .card-dark[data-var="lluvia"] .icon {
            color: var(--prec-color);
        }

        .card-dark[data-var="slrw"] .icon {
            color: var(--rad-color);
        }

        .card-dark.active .icon {
            transform: scale(1.1);
        }

        .card-dark .main-value {
            font-size: 1.05rem;
            font-weight: 700;
            margin: 1px 0;
            color: var(--primary-dark);
        }

        .card-dark .card-label {
            font-size: 0.85rem;
            color: var(--secondary);
            margin-top: 1px;
            line-height: 1.2;
            font-weight: 500;
        }

        .card-dark .card-time {
            font-size: 0.75rem;
            color: var(--gray-medium);
            margin-top: 1px;
            font-weight: 500;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 8px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: height 0.3s ease;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .chart-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .time-indicator {
            font-size: 0.85rem;
            color: var(--secondary);
            text-align: right;
            margin-top: 3px;
            font-weight: 500;
        }

        .info-note {
            font-size: 0.8rem;
            color: var(--gray-medium);
            margin-top: 2px;
            font-weight: 500;
        }

        .date-selector-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(0, 51, 102, 0.05);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .date-selector {
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            min-width: 160px;
        }

        .date-warning {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 5px;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 0.9rem;
            display: none;
            font-weight: 500;
        }

        .date-warning.show {
            display: block;
        }

        .download-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 51, 102, 0.05);
            border-radius: 8px;
        }

        .download-control-group {
            display: flex;
            flex-direction: column;
            min-width: 160px;
        }

        .download-label {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 2px;
            font-size: 0.9rem;
        }

        .download-select {
            border-radius: 5px;
            border: 1px solid #d0d0d0;
            padding: 4px 7px;
            font-size: 0.9rem;
            background: white;
        }

        .chart-info-panel {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.85rem;
            flex-wrap: wrap;
            padding-top: 6px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chart-stat {
            padding: 5px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.03);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            min-width: 140px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin: 2px;
            transition: all 0.2s ease;
        }

        .chart-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .chart-stat.max {
            color: #e74c3c;
            border-left: 4px solid #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }

        .chart-stat.min {
            color: #0066a1;
            border-left: 4px solid #0066a1;
            background: rgba(0, 102, 161, 0.05);
        }

        .chart-stat.avg {
            color: #003366;
            border-left: 4px solid #003366;
            background: rgba(0, 51, 102, 0.05);
        }

        .chart-stat.total {
            color: #001a33;
            border-left: 4px solid #001a33;
            background: rgba(0, 26, 51, 0.05);
        }

        .stat-value {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .stat-date {
            font-size: 0.75rem;
            color: var(--gray-medium);
            white-space: nowrap;
            margin-left: 5px;
            font-weight: 500;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .chart-item {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .chart-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .chart-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .chart-item-title {
            font-size: 1.0rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chart-item-title i {
            font-size: 1.2rem;
        }

        .chart-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
        }

        .chart-container {
            min-width: 550px;
        }

        .size-control {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .size-label {
            color: var(--secondary);
            white-space: nowrap;
            font-weight: 500;
        }

        .size-slider {
            flex: 1;
            max-width: 120px;
        }

        .chart-date-picker {
            padding: 4px 7px;
            font-size: 0.9rem;
            border-radius: 5px;
            border: 1px solid #d0d0d0;
            background: white;
            min-width: 130px;
        }

        .loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 4px 8px;
            border-radius: 5px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 100%;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 4px 8px;
            border-radius: 5px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 100%;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
            transform: translateY(-2px);
        }

        .refresh-all-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            padding: 4px 8px;
            border-radius: 5px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .refresh-all-btn:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
        }

        .back-to-stations {
            position: absolute;
            left: 10px;
            top: 10px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: var(--shadow);
            text-decoration: none;
        }

        .back-to-stations:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .footer {
            background: var(--primary-dark);
            color: var(--light);
            padding: 20px 15px 12px;
            border-radius: var(--border-radius);
            margin-top: 25px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .footer-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
        }

        .footer-description {
            color: #e0e0e0;
            line-height: 1.5;
            margin-bottom: 12px;
            font-size: 0.85rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .contact-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 0.8rem;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #e0e0e0;
        }

        .contact-icon {
            color: var(--secondary);
        }

        .copyright {
            text-align: center;
            padding-top: 12px;
            margin-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .credits {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 0.85rem;
            color: #a8dadc;
            font-style: italic;
        }

        /* ===== ANIMACIONES ===== */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes droplet {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(2px);
            }
        }

        @keyframes rain {

            0%,
            100% {
                transform: rotate(0);
            }

            25% {
                transform: rotate(3deg);
            }

            75% {
                transform: rotate(-3deg);
            }
        }

        @keyframes shine {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ===== SECCIÓN DE COOPERANTES ===== */
        .cooperantes-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.8s ease-out;
        }

        .cooperantes-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            padding-bottom: 8px;
        }

        .cooperantes-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--secondary);
            border-radius: 2px;
        }

        .cooperantes-logos {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .cooperante-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            transition: all 0.3s ease;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .cooperante-logo-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
            background: white;
        }

        .cooperante-logo {
            object-fit: contain;
            transition: all 0.3s ease;
            filter: grayscale(20%);
        }

        .cooperante-logo-container:hover .cooperante-logo {
            filter: grayscale(0%);
            transform: scale(1.05);
        }

        #belgium-logo {
            height: var(--logo-belgium-height);
        }

        #flanders-logo {
            height: var(--logo-flanders-height);
        }

        #protos-logo {
            height: var(--logo-protos-height);
        }

        #unj-logo {
            height: var(--logo-unj-height);
            width: 180px;
            /* Ancho fijo para mantener proporción */
            object-fit: contain;
            /* Asegura que mantenga proporciones */
        }

        #nci-logo {
            height: var(--logo-nci-height);
        }

        #joinforwater-coop-logo {
            height: var(--logo-joinforwater-coop-height);
        }

        #jocotoco-coop-logo {
            height: var(--logo-jocotoco-coop-height);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ajuste del contenedor de logos para pantallas grandes */
        @media (min-width: 1200px) {
            .cooperantes-logos {
                gap: 20px;
                /* Más espacio entre logos */
            }
        }

        /* ================= IDIOMA - POSICIONAMIENTO MEJORADO ================= */
        .language-switcher {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            gap: 5px;
        }

        .btn-lang {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 60px;
            justify-content: center;
        }

        .btn-lang:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-lang.active {
            background: var(--secondary);
            transform: scale(1.05);
        }

        .flag-icon {
            width: var(--flag-size);
            height: var(--flag-size);
            border-radius: 50%;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
        }

        .lang-text-mobile {
            display: none;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1100px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .header-section {
                flex-direction: column;
                padding: 15px 0;
                gap: 15px;
                text-align: center;
            }

            .title-container {
                padding-right: 0;
                padding: 0 15px;
            }

            .logos-container {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 15px;
            }

            :root {
                --logo-unl-height: 80px;
                --logo-citiab-height: 120px;
                --logo-jocotoco-height: 100px;
                --logo-joinforwater-height: 90px;
                --logo-belgium-height: 60px;
                --logo-flanders-height: 60px;
                --logo-protos-height: 60px;
                --logo-unj-height: 60px;
                --logo-nci-height: 60px;
                --logo-joinforwater-coop-height: 60px;
                --logo-jocotoco-coop-height: 60px;
                --flag-size: 20px;
            }

            .date-selector {
                flex-direction: column;
            }

            .chart-controls {
                flex-wrap: wrap;
            }

            .cooperantes-logos {
                gap: 12px;
            }

            #unj-logo {
                width: 140px;
                /* Ajuste para móviles */
            }
        }

        @media (max-width: 768px) {
            .chart-item-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .chart-info-panel {
                flex-direction: column;
                gap: 5px;
            }

            .chart-container {
                min-width: 100%;
            }

            .back-to-stations {
                position: relative;
                left: 0;
                top: 0;
                margin-bottom: 10px;
                width: 100%;
            }

            .cooperantes-logos {
                gap: 10px;
            }
            
            /* Mobile language button */
            .language-switcher {
                top: 15px;
                right: 15px;
            }

            .btn-lang {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .lang-text-desktop {
                display: none;
            }

            .lang-text-mobile {
                display: inline;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            .section-title {
                font-size: 1.4rem;
            }

            .card-dark {
                min-height: 60px;
            }

            .size-slider {
                max-width: 80px;
            }

            :root {
                --logo-unl-height: 70px;
                --logo-citiab-height: 100px;
                --logo-jocotoco-height: 85px;
                --logo-joinforwater-height: 80px;
                --logo-belgium-height: 50px;
                --logo-flanders-height: 50px;
                --logo-protos-height: 50px;
                --logo-unj-height: 50px;
                --logo-nci-height: 50px;
                --logo-joinforwater-coop-height: 50px;
                --logo-jocotoco-coop-height: 50px;
                --flag-size: 18px;
            }

            .cooperantes-logos {
                gap: 8px;
            }

            #unj-logo {
                width: 120px;
                /* Ajuste para móviles pequeños */
            }
            
            /* Mobile language button */
            .language-switcher {
                top: 10px;
                right: 10px;
            }

            .btn-lang {
                padding: 6px 10px;
                font-size: 0.8rem;
                min-width: 50px;
            }
        }
    </style>
</head>

<body>
  <!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estação Meteorológica Tapichalaca - CITIAB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* ... (todos los estilos CSS anteriores permanecen iguales) ... */
    </style>
</head>

<body>
    <!-- Botón para volver a la pantalla principal -->
    <a href="https://estaciones-citiab.vercel.app/" class="back-to-stations" id="back-link">
        <i class="fas fa-arrow-left"></i> <span id="back-text">Volver a Visor</span>
    </a>
    
    <div class="language-switcher">
        <button id="languageButton" class="btn-lang">
            <i class="fas fa-globe"></i>
            <span id="lang-text" class="lang-text-desktop">ES</span>
            <span id="lang-text-mobile" class="lang-text-mobile"></span>
        </button>
    </div>

    <div class="app-container">
        <header class="header-section">
            <div class="title-container">
                <h1 id="page-title">Estación Meteorológica Tapichalaca</h1>
                <div class="subtitle" id="page-subtitle">Reserva Tapichalaca, Zamora Chinchipe, Ecuador<br>Estación de monitoreo ambiental CITIAB</div>
            </div>

            <div class="logos-container">
                <div class="logo-container">
                    <img src="https://joinforwater.ngo/wp-content/uploads/2022/05/logo-unl-HC-01-e1651758359420.png"
                        class="logo" alt="Logo UNL" id="unl-logo">
                </div>
                <div class="logo-container">
                    <img src="https://unl.edu.ec/sites/default/files/inline-images/logo%20citiab%202%20%281%29.png"
                        class="logo" alt="Logo CITIAB" id="citiab-logo">
                </div>
                <div class="logo-container">
                    <img src="https://i.ibb.co/6cpH5wWs/Whats-App-Image-2025-07-14-at-3-46-22-PM-removebg-preview-1.png"
                        class="logo" alt="Join For Water" id="joinforwater-logo">
                </div>
                <div class="logo-container">
                    <img src="https://i.ibb.co/M5yd0kZJ/472789761-1105565828029024-3870823381710171305-n-1.jpg"
                        class="logo" alt="Fundación Jocotoco" id="jocotoco-logo">
                </div>
            </div>
        </header>

        <section class="station-section">
            <div class="section-title-container">
                <h2 class="section-title" id="section-title">Monitoreo en Tiempo Real</h2>
            </div>

            <div class="station-card">
                <div class="card-header">
                    <div class="station-icon">
                        <i class="fas fa-cloud-sun"></i>
                    </div>
                    <div class="station-info">
                        <h3 class="station-name" id="station-name">Datos Actuales</h3>
                        <div class="status-indicator status-online">
                            <span class="status-dot"></span>
                            <span id="status-text">En línea - Datos actualizados</span>
                        </div>
                    </div>
                </div>

                <div class="data-cards">
                    <div class="card-dark active" data-var="airTC">
                        <i class="fas fa-thermometer-half icon"></i>
                        <div class="main-value">--°C</div>
                        <div class="card-label" id="label-temp">Temperatura del Aire</div>
                        <div class="card-time">--:--</div>
                    </div>

                    <div class="card-dark" data-var="Rh">
                        <i class="fas fa-tint icon"></i>
                        <div class="main-value">--%</div>
                        <div class="card-label" id="label-hum">Humedad Relativa</div>
                        <div class="card-time">--:--</div>
                    </div>

                    <div class="card-dark" data-var="lluvia">
                        <i class="fas fa-cloud-rain icon"></i>
                        <div class="main-value">-- mm</div>
                        <div class="card-label" id="label-prec">Precipitación</div>
                        <div class="card-time">--:--</div>
                    </div>

                    <div class="card-dark" data-var="slrw">
                        <i class="fas fa-sun icon"></i>
                        <div class="main-value">-- W/m²</div>
                        <div class="card-label" id="label-rad">Radiación Solar</div>
                        <div class="card-time">--:--</div>
                    </div>
                </div>

                <div class="header-section">
                    <div></div>
                    <button class="refresh-all-btn" id="refreshAllBtn">
                        <i class="fas fa-sync-alt"></i> <span id="refresh-text">Actualizar Todo</span>
                    </button>
                </div>

                <div class="date-selector-container">
                    <div class="date-selector">
                        <div class="date-input-group">
                            <label for="startDate" class="download-label" id="label-start-date">Fecha de inicio:</label>
                            <input type="date" id="startDate" class="download-select" min="2025-07-09" />
                        </div>

                        <div class="date-input-group">
                            <label for="endDate" class="download-label" id="label-end-date">Fecha de fin:</label>
                            <input type="date" id="endDate" class="download-select" min="2025-07-09" />
                        </div>

                        <div class="download-control-group">
                            <label class="download-label" id="label-download-interval">Intervalo para descarga:</label>
                            <select id="downloadIntervalSelect" class="download-select">
                                <option value="1min">1 minuto (datos crudos)</option>
                                <option value="5min">5 minutos</option>
                                <option value="15min">15 minutos</option>
                                <option value="30min">30 minutos</option>
                                <option value="60min">60 minutos</option>
                                <option value="daily">Diario</option>
                            </select>
                        </div>

                        <div class="download-control-group">
                            <label class="download-label" id="label-file-format">Formato de archivo:</label>
                            <select id="fileFormatSelect" class="download-select">
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="csv">CSV (.csv)</option>
                            </select>
                        </div>

                        <div class="d-flex align-items-end mt-2">
                            <button class="btn btn-success" id="downloadRangeBtn">
                                <i class="fas fa-download"></i> <span id="download-text">Descargar datos</span>
                            </button>
                        </div>
                    </div>

                    <div class="info-note" id="data-note">*Datos disponibles desde 9 julio 2025</div>
                    <div class="date-warning" id="dateWarning">
                        <strong id="warning-strong">Nota:</strong> <span id="warning-text">Para obtener todos los datos del rango seleccionado, asegúrese de seleccionar fechas válidas. El sistema descargará automáticamente todas las mediciones disponibles para el período seleccionado.</span>
                    </div>
                </div>

                <div class="chart-header">
                    <div class="chart-title" id="chart-title">Datos Históricos</div>
                    <div class="chart-controls">
                        <div class="chart-control-group">
                            <span class="chart-control-label">
                                <i class="fas fa-calendar"></i> <span id="label-date-picker">Seleccione fecha:</span>
                            </span>
                            <input type="date" id="chartDatePicker" class="chart-date-picker" />
                        </div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-item">
                        <div class="chart-item-header">
                            <div class="chart-item-title">
                                <i class="fas fa-thermometer-half" style="color: var(--temp-color);"></i>
                                <span id="chart-temp-title">Temperatura del Aire (°C) - Promedio horario</span>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-container" id="tempChartContainer" style="height: 250px;">
                                <canvas id="tempChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-info-panel">
                            <div class="chart-stat max">
                                <i class="fas fa-arrow-up"></i> <span id="stat-max">Máx</span>: <span id="maxValueTemp"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="maxDateTemp">--:--</span>
                            </div>
                            <div class="chart-stat min">
                                <i class="fas fa-arrow-down"></i> <span id="stat-min">Mín</span>: <span id="minValueTemp"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="minDateTemp">--:--</span>
                            </div>
                            <div class="chart-stat avg">
                                <i class="fas fa-minus"></i> <span id="stat-avg">Prom</span>: <span id="avgValueTemp" class="stat-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-item">
                        <div class="chart-item-header">
                            <div class="chart-item-title">
                                <i class="fas fa-tint" style="color: var(--hum-color);"></i>
                                <span id="chart-hum-title">Humedad Relativa (%) - Promedio horario</span>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-container" id="humChartContainer" style="height: 250px;">
                                <canvas id="humChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-info-panel">
                            <div class="chart-stat max">
                                <i class="fas fa-arrow-up"></i> <span id="stat-max2">Máx</span>: <span id="maxValueHum" class="stat-value">--</span>
                                <span class="stat-date" id="maxDateHum">--:--</span>
                            </div>
                            <div class="chart-stat min">
                                <i class="fas fa-arrow-down"></i> <span id="stat-min2">Mín</span>: <span id="minValueHum"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="minDateHum">--:--</span>
                            </div>
                            <div class="chart-stat avg">
                                <i class="fas fa-minus"></i> <span id="stat-avg2">Prom</span>: <span id="avgValueHum" class="stat-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-item">
                        <div class="chart-item-header">
                            <div class="chart-item-title">
                                <i class="fas fa-cloud-rain" style="color: var(--prec-color);"></i>
                                <span id="chart-prec-title">Precipitación (mm) - Suma horaria</span>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-container" id="precChartContainer" style="height: 250px;">
                                <canvas id="precChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-info-panel">
                            <div class="chart-stat max">
                                <i class="fas fa-arrow-up"></i> <span id="stat-max3">Máx</span>: <span id="maxValuePrec"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="maxDatePrec">--:--</span>
                            </div>
                            <div class="chart-stat min">
                                <i class="fas fa-arrow-down"></i> <span id="stat-min3">Mín</span>: <span id="minValuePrec"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="minDatePrec">--:--</span>
                            </div>
                            <div class="chart-stat avg">
                                <i class="fas fa-minus"></i> <span id="stat-avg3">Prom</span>: <span id="avgValuePrec" class="stat-value">--</span>
                            </div>
                            <div class="chart-stat total">
                                <i class="fas fa-plus-circle"></i> <span id="stat-total">Total</span>: <span id="totalValuePrec"
                                    class="stat-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-item">
                        <div class="chart-item-header">
                            <div class="chart-item-title">
                                <i class="fas fa-sun" style="color: var(--rad-color);"></i>
                                <span id="chart-rad-title">Radiación Solar (W/m²) - Promedio horario</span>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-container" id="radChartContainer" style="height: 250px;">
                                <canvas id="radChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-info-panel">
                            <div class="chart-stat max">
                                <i class="fas fa-arrow-up"></i> <span id="stat-max4">Máx</span>: <span id="maxValueRad" class="stat-value">--</span>
                                <span class="stat-date" id="maxDateRad">--:--</span>
                            </div>
                            <div class="chart-stat min">
                                <i class="fas fa-arrow-down"></i> <span id="stat-min4">Mín</span>: <span id="minValueRad"
                                    class="stat-value">--</span>
                                <span class="stat-date" id="minDateRad">--:--</span>
                            </div>
                            <div class="chart-stat avg">
                                <i class="fas fa-minus"></i> <span id="stat-avg4">Prom</span>: <span id="avgValueRad" class="stat-value">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN DE COOPERANTES -->
                <div class="cooperantes-section">
                    <div class="cooperantes-title" id="cooperantes-title">Con el apoyo de:</div>
                    <div class="cooperantes-logos">
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/7Bfkpg8/Belgium-CMYK.jpg" alt="Cooperación Belga"
                                class="cooperante-logo" id="belgium-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/23nDmtnm/Flanders-en-amarillo.png" alt="Flanders"
                                class="cooperante-logo" id="flanders-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/v6Kn8RLf/Join-For-Water-cmyk.png" alt="Join For Water"
                                class="cooperante-logo" id="joinforwater-coop-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/60TJW3t1/3-Protos-Andes.jpg" alt="Protos Andes"
                                class="cooperante-logo" id="protos-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/cXYMw668/jaen-1.jpg" alt="Universidad Nacional de Jaén"
                                class="cooperante-logo" id="unj-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/3XrwLkr/NCI-Shaker-Original-Spanish-RGB.png" alt="NCI"
                                class="cooperante-logo" id="nci-logo">
                        </div>
                        <div class="cooperante-logo-container">
                            <img src="https://i.ibb.co/pjwV3RZb/logo-Jocotoco.png" alt="Fundación Jocotoco"
                                class="cooperante-logo" id="jocotoco-coop-logo">
                        </div>
                    </div>
                    <br>
                </div>

                <div class="time-indicator" id="time-indicator">Última actualización: --:--:--</div>
            </div>
        </section>

        <footer class="footer">
            <div class="footer-content">
                <h3 class="footer-title" id="footer-title">Centro de Investigaciones Tropicales del Ambiente y Biodiversidad (CITIAB)</h3>
                <p class="footer-description" id="footer-desc">
                    Investigamos biodiversidad, restauración de paisajes, servicios ecosistémicos, hidrología y cambio
                    climático para contribuir al conocimiento científico y la conservación ambiental.
                </p>

                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-map-marker-alt contact-icon"></i>
                        <footer>
  <address id="footer-address"> Ciudad Universitaria Guillermo Falconí, Facultad Agropecuaria – Edificio 83, Segundo Piso, Loja – Ecuador </address> </footer>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<!-- Website -->                    
<footer>
  <p id="footer-link">
    <a href="https://unl.edu.ec/citiab" target="_blank" rel="noopener noreferrer" class="white-link">
       <i class="fas fa-link contact-icon"></i> &nbsp; Página Web
    </a>
  </p>
</footer>

<style>
  .white-link {
    text-decoration: none; /* Quita subrayado  */
    color: #f8f9fa;
  }

  .white-link:hover {
    text-decoration: underline; /* Opcional: subrayado al pasar el mouse */
  }

</style>

<!-- Facebook -->
<footer>
  <p id="footer-link">
    <a href="https://www.facebook.com/citabunl" target="_blank" rel="noopener noreferrer" class="white-link">
      <i class="fab fa-facebook contact-icon"></i> &nbsp; Facebook
    </a>
  </p>
</footer>

<style>
  .white-link {
    text-decoration: none; /* Quita subrayado */
    color: #f8f9fa;     
  }

  .white-link:hover {
    text-decoration: underline; /* Subrayado al pasar el mouse */
  }
</style>

<!-- Instagram -->
<footer>
<p id="footer-link">
    <a href="https://www.instagram.com/citiab.oficial?igsh=MWw0cTY4ZW0weHY0aA==" target="_blank" rel="noopener noreferrer" class="white-link">
      <i class="fab fa-instagram contact-icon"></i> &nbsp; Instagram
    </a>
  </p>
</footer>

<style>
  .white-link {
    text-decoration: none; /* Quita subrayado */
    color: #f8f9fa;        
  }

  .white-link:hover {
    text-decoration: underline; /* Subrayado al pasar el mouse */
  }
</style>

<!-- X -->
<footer>
<p id="footer-link">
    <a href="https://x.com/citiab_UNL?t=Fxk9M0ZWLe3GZyhC7nTMvg&s=08" target="_blank" rel="noopener noreferrer" class="white-link">
      <i class="fab fa-x contact-icon"></i> &nbsp; X
    </a>
  </p>
</footer>

<style>
  .white-link {
    text-decoration: none; /* Quita subrayado */
    color: #f8f9fa;        
  }

  .white-link:hover {
    text-decoration: underline; /* Subrayado al pasar el mouse */
  }
</style> 
                </div>

                <div class="credits" id="footer-credits">
                    Desarrollado por el Ing. Kevin David Loja Sarmiento en colaboración del Mgs. Juan Dario Quinde y el
                    Centro de Investigación CITIAB
                </div>

                <div class="copyright" id="footer-copyright">
                    &copy; 2025 CITIAB - Universidad Nacional de Loja. Todos los derechos reservados.
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabase = createClient(
            'https://ecuossvqnlodykbgemqh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVjdW9zc3ZxbmxvZHlrYmdlbXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NDQzMDMsImV4cCI6MjA2NTMyMDMwM30.aCVFkPpjdf2KR4M8Qjd3JT_ieuIG5YMtM-2UmBxKYBQ'
        );
        const TABLE_NAME = 'tapichalaca';

        // Sistema de traducción mejorado con portugués
        const translations = {
            es: {
                back: "Volver a Visor",
                mainTitle: "Estación Meteorológica Tapichalaca",
                subtitle: "Reserva Tapichalaca, Zamora Chinchipe, Ecuador<br>Estación de monitoreo ambiental CITIAB",
                sectionTitle: "Monitoreo en Tiempo Real",
                stationName: "Datos Actuales",
                statusText: "En línea - Datos actualizados",
                labelTemp: "Temperatura del Aire",
                labelHum: "Humedad Relativa",
                labelPrec: "Precipitación",
                labelRad: "Radiación Solar",
                refreshBtn: "Actualizar Todo",
                labelStartDate: "Fecha de inicio:",
                labelEndDate: "Fecha de fin:",
                labelDownloadInterval: "Intervalo para descarga:",
                labelFileFormat: "Formato de archivo:",
                downloadBtn: "Descargar datos",
                dataNote: "*Datos disponibles desde 9 julio 2025",
                dateWarningStrong: "Nota:",
                dateWarningText: "Para obtener todos los datos del rango seleccionado, asegúrese de seleccionar fechas válidas. El sistema descargará automáticamente todas las mediciones disponibles para el período seleccionado.",
                chartTitle: "Datos Históricos",
                labelDatePicker: "Seleccione fecha:",
                chartTempTitle: "Temperatura del Aire (°C) - Promedio horario",
                chartHumTitle: "Humedad Relativa (%) - Promedio horario",
                chartPrecTitle: "Precipitación (mm) - Suma horaria",
                chartRadTitle: "Radiación Solar (W/m²) - Promedio horario",
                statMax: "Máx",
                statMin: "Mín",
                statAvg: "Prom",
                statTotal: "Total",
                timeIndicator: "Última actualización:",
                footerTitle: "Centro de Investigaciones Tropicales del Ambiente y Biodiversidad (CITIAB)",
                footerDesc: "Investigamos biodiversidad, restauración de paisajes, servicios ecosistémicos, hidrología y cambio climático para contribuir al conocimiento científico y la conservación ambiental.",
                footerLocation: "Ciudad Universitaria Guillermo Falconí - Loja - Ecuador",
                footerPhone: "07 2593550",
                footerEmail: "comunicacion@unl.edu.ec",
                footerCredits: "Desarrollado por el Ing. Kevin David Loja Sarmiento en colaboración del Mgs. Juan Dario Quinde y el Centro de Investigación CITIAB",
                footerCopyright: "&copy; 2025 CITIAB - Universidad Nacional de Loja. Todos los derechos reservados.",
                langText: "ES",
                cooperantesTitle: "Con el apoyo de:",
                axisX: "Hora del día",
                axisY: "Valor",
                formatOptionExcel: "Excel (.xlsx)",
                formatOptionCSV: "CSV (.csv)"
            },
            en: {
                back: "Back to Dashboard",
                mainTitle: "Tapichalaca Meteorological Station",
                subtitle: "Tapichalaca Reserve, Zamora Chinchipe, Ecuador<br>CITIAB Environmental Monitoring Station",
                sectionTitle: "Real-Time Monitoring",
                stationName: "Current Data",
                statusText: "Online - Updated data",
                labelTemp: "Air Temperature",
                labelHum: "Relative Humidity",
                labelPrec: "Precipitation",
                labelRad: "Solar Radiation",
                refreshBtn: "Refresh All",
                labelStartDate: "Start date:",
                labelEndDate: "End date:",
                labelDownloadInterval: "Download interval:",
                labelFileFormat: "File format:",
                downloadBtn: "Download data",
                dataNote: "*Data available since July 9, 2025",
                dateWarningStrong: "Note:",
                dateWarningText: "To get all data for the selected range, make sure to select valid dates. The system will automatically download all available measurements for the selected period.",
                chartTitle: "Historical Data",
                labelDatePicker: "Select date:",
                chartTempTitle: "Air Temperature (°C) - Hourly average",
                chartHumTitle: "Relative Humidity (%) - Hourly average",
                chartPrecTitle: "Precipitation (mm) - Hourly sum",
                chartRadTitle: "Solar Radiation (W/m²) - Hourly average",
                statMax: "Max",
                statMin: "Min",
                statAvg: "Avg",
                statTotal: "Total",
                timeIndicator: "Last update:",
                footerTitle: "Center for Tropical Research on Environment and Biodiversity (CITIAB)",
                footerDesc: "We research biodiversity, landscape restoration, ecosystem services, hydrology and climate change to contribute to scientific knowledge and environmental conservation.",
                footerLocation: "University City Guillermo Falconí - Loja - Ecuador",
                footerPhone: "07 2593550",
                footerEmail: "comunicacion@unl.edu.ec",
                footerCredits: "Developed by Eng. Kevin David Loja Sarmiento in collaboration with Mgs. Juan Dario Quinde and the CITIAB Research Center",
                footerCopyright: "&copy; 2025 CITIAB - National University of Loja. All rights reserved.",
                langText: "EN",
                cooperantesTitle: "With the support of:",
                axisX: "Time of day",
                axisY: "Value",
                formatOptionExcel: "Excel (.xlsx)",
                formatOptionCSV: "CSV (.csv)"
            },
            pt: {
                back: "Voltar ao Painel",
                mainTitle: "Estação Meteorológica Tapichalaca",
                subtitle: "Reserva Tapichalaca, Zamora Chinchipe, Equador<br>Estação de monitoramento ambiental CITIAB",
                sectionTitle: "Monitoramento em Tempo Real",
                stationName: "Dados Atuais",
                statusText: "Online - Dados atualizados",
                labelTemp: "Temperatura do Ar",
                labelHum: "Umidade Relativa",
                labelPrec: "Precipitação",
                labelRad: "Radiação Solar",
                refreshBtn: "Atualizar Tudo",
                labelStartDate: "Data de início:",
                labelEndDate: "Data de término:",
                labelDownloadInterval: "Intervalo para download:",
                labelFileFormat: "Formato do arquivo:",
                downloadBtn: "Baixar dados",
                dataNote: "*Dados disponíveis desde 9 de julho de 2025",
                dateWarningStrong: "Nota:",
                dateWarningText: "Para obter todos os dados do intervalo selecionado, certifique-se de selecionar datas válidas. O sistema baixará automaticamente todas as medições disponíveis para o período selecionado.",
                chartTitle: "Dados Históricos",
                labelDatePicker: "Selecione a data:",
                chartTempTitle: "Temperatura do Ar (°C) - Média horária",
                chartHumTitle: "Umidade Relativa (%) - Média horária",
                chartPrecTitle: "Precipitação (mm) - Soma horária",
                chartRadTitle: "Radiação Solar (W/m²) - Média horária",
                statMax: "Máx",
                statMin: "Mín",
                statAvg: "Méd",
                statTotal: "Total",
                timeIndicator: "Última atualização:",
                footerTitle: "Centro de Pesquisas Tropicais em Meio Ambiente e Biodiversidade (CITIAB)",
                footerDesc: "Pesquisamos biodiversidade, restauração de paisagens, serviços ecossistêmicos, hidrologia e mudanças climáticas para contribuir com o conhecimento científico e a conservação ambiental.",
                footerLocation: "Cidade Universitária Guillermo Falconí - Loja - Equador",
                footerPhone: "07 2593550",
                footerEmail: "comunicacion@unl.edu.ec",
                footerCredits: "Desenvolvido pelo Eng. Kevin David Loja Sarmiento em colaboração com Mgs. Juan Dario Quinde e o Centro de Pesquisa CITIAB",
                footerCopyright: "&copy; 2025 CITIAB - Universidade Nacional de Loja. Todos os direitos reservados.",
                langText: "PT",
                cooperantesTitle: "Com o apoio de:",
                axisX: "Hora do dia",
                axisY: "Valor",
                formatOptionExcel: "Excel (.xlsx)",
                formatOptionCSV: "CSV (.csv)"
            }
        };

        let currentLang = 'es'; // Idioma por defecto

        // Función para actualizar las opciones del selector de formato
        function updateFileFormatSelect() {
            const select = document.getElementById('fileFormatSelect');
            select.innerHTML = ''; // Limpiar opciones
            
            // Crear nuevas opciones basadas en el idioma actual
            const excelOption = document.createElement('option');
            excelOption.value = 'xlsx';
            excelOption.textContent = translations[currentLang].formatOptionExcel;
            select.appendChild(excelOption);
            
            const csvOption = document.createElement('option');
            csvOption.value = 'csv';
            csvOption.textContent = translations[currentLang].formatOptionCSV;
            select.appendChild(csvOption);
        }

        function changeLanguage() {
            // Rotar entre idiomas: es -> en -> pt -> es...
            const languages = ['es', 'en', 'pt'];
            const currentIndex = languages.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % languages.length;
            currentLang = languages[nextIndex];

            // Actualizar textos
            document.getElementById('back-link').innerHTML = `<i class="fas fa-arrow-left"></i> ${translations[currentLang].back}`;
            document.getElementById('page-title').textContent = translations[currentLang].mainTitle;
            document.getElementById('page-subtitle').innerHTML = translations[currentLang].subtitle;
            document.getElementById('section-title').textContent = translations[currentLang].sectionTitle;
            document.getElementById('station-name').textContent = translations[currentLang].stationName;
            document.getElementById('status-text').textContent = translations[currentLang].statusText;
            document.getElementById('label-temp').textContent = translations[currentLang].labelTemp;
            document.getElementById('label-hum').textContent = translations[currentLang].labelHum;
            document.getElementById('label-prec').textContent = translations[currentLang].labelPrec;
            document.getElementById('label-rad').textContent = translations[currentLang].labelRad;
            document.getElementById('refresh-text').textContent = translations[currentLang].refreshBtn;
            document.getElementById('label-start-date').textContent = translations[currentLang].labelStartDate;
            document.getElementById('label-end-date').textContent = translations[currentLang].labelEndDate;
            document.getElementById('label-download-interval').textContent = translations[currentLang].labelDownloadInterval;
            document.getElementById('label-file-format').textContent = translations[currentLang].labelFileFormat;
            document.getElementById('download-text').textContent = translations[currentLang].downloadBtn;
            document.getElementById('data-note').textContent = translations[currentLang].dataNote;
            document.getElementById('warning-strong').textContent = translations[currentLang].dateWarningStrong;
            document.getElementById('warning-text').textContent = translations[currentLang].dateWarningText;
            document.getElementById('chart-title').textContent = translations[currentLang].chartTitle;
            document.getElementById('label-date-picker').textContent = translations[currentLang].labelDatePicker;
            document.getElementById('chart-temp-title').textContent = translations[currentLang].chartTempTitle;
            document.getElementById('chart-hum-title').textContent = translations[currentLang].chartHumTitle;
            document.getElementById('chart-prec-title').textContent = translations[currentLang].chartPrecTitle;
            document.getElementById('chart-rad-title').textContent = translations[currentLang].chartRadTitle;
            document.getElementById('cooperantes-title').textContent = translations[currentLang].cooperantesTitle;
            
            // Actualizar estadísticas
            document.querySelectorAll('#stat-max').forEach(el => el.textContent = translations[currentLang].statMax);
            document.querySelectorAll('#stat-min').forEach(el => el.textContent = translations[currentLang].statMin);
            document.querySelectorAll('#stat-avg').forEach(el => el.textContent = translations[currentLang].statAvg);
            document.getElementById('stat-total').textContent = translations[currentLang].statTotal;
            
            document.getElementById('time-indicator').textContent = `${translations[currentLang].timeIndicator} --:--:--`;
            document.getElementById('footer-title').textContent = translations[currentLang].footerTitle;
            document.getElementById('footer-desc').textContent = translations[currentLang].footerDesc;
            document.getElementById('footer-location').textContent = translations[currentLang].footerLocation;
            document.getElementById('footer-phone').textContent = translations[currentLang].footerPhone;
            document.getElementById('footer-email').textContent = translations[currentLang].footerEmail;
            document.getElementById('footer-credits').textContent = translations[currentLang].footerCredits;
            document.getElementById('footer-copyright').innerHTML = translations[currentLang].footerCopyright;
            document.getElementById('lang-text').textContent = translations[currentLang].langText;
            document.getElementById('lang-text-mobile').textContent = translations[currentLang].langText;
            
            // Actualizar selector de formato
            updateFileFormatSelect();
            
            // Actualizar gráficos (para cambiar los ejes)
            updateChartAxes();
            
            // Actualizar gráficos con nuevos datos
            updateChart();
        }

        // Función para crear fecha en zona horaria local
        function createLocalDate(year, month, day) {
            return new Date(year, month - 1, day);
        }

        // Función para formatear fecha a YYYY-MM-DD en zona local
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Función para mostrar fecha en formato local
        function displayLocalDate(date) {
            return date.toLocaleDateString('es-EC', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // FUNCIÓN PARA FORMATEAR TIEMPO SIN CAMBIAR ZONA HORARIA
        function formatUTCTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (isNaN(date)) return isoString;

            // Obtener componentes UTC sin conversión
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const seconds = String(date.getUTCSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        const variableColors = {
            airTC: '#e74c3c',
            lluvia: '#003366',
            Rh: '#0066a1',
            slrw: '#f1c40f'
        };

        const variableMeta = {
            airTC: {
                label: "Temperatura del Aire",
                unit: "°C",
                icon: "fa-thermometer-half",
                color: variableColors.airTC
            },
            lluvia: {
                label: "Precipitación",
                unit: "mm",
                icon: "fa-cloud-rain",
                color: variableColors.lluvia
            },
            Rh: {
                label: "Humedad Relativa",
                unit: "%",
                icon: "fa-tint",
                color: variableColors.Rh
            },
            slrw: {
                label: "Radiación Solar",
                unit: "W/m²",
                icon: "fa-sun",
                color: variableColors.slrw
            }
        };

        // Crear las 4 gráficas
        const tempCtx = document.getElementById('tempChart').getContext('2d');
        const humCtx = document.getElementById('humChart').getContext('2d');
        const precCtx = document.getElementById('precChart').getContext('2d');
        const radCtx = document.getElementById('radChart').getContext('2d');

        // Función para crear gráficas con ejes horarios
        function createChart(ctx, color, label, xAxisLabel, yAxisLabel) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(24).fill().map((_, i) => `${i.toString().padStart(2, '0')}:00`),
                    datasets: [{
                        label: label,
                        data: Array(24).fill(null),
                        borderColor: color,
                        backgroundColor: color + '33',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        fill: false,
                        tension: 0.3,
                        cubicInterpolationMode: 'monotone'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#003366',
                            bodyColor: '#003366',
                            borderColor: 'rgba(0, 0, 0, 0.05)',
                            borderWidth: 1,
                            padding: 7,
                            displayColors: true,
                            callbacks: {
                                title: function (tooltipItems) {
                                    return tooltipItems[0].label;
                                },
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.parsed.y !== null ? context.parsed.y.toFixed(2) : 'N/A'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.03)'
                            },
                            title: {
                                display: true,
                                text: xAxisLabel,
                                color: '#003366',
                                font: { weight: 'bold', size: 11 }
                            },
                            ticks: {
                                color: '#003366',
                                font: { weight: 'bold', size: 9 },
                                maxRotation: 0,
                                minRotation: 0,
                                padding: 5,
                                callback: function (value, index) {
                                    return value;
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.03)',
                                borderDash: [4, 4]
                            },
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: '#003366',
                                font: { weight: 'bold', size: 11 }
                            },
                            ticks: {
                                color: '#003366',
                                font: { weight: 'bold', size: 9 },
                                padding: 4,
                                callback: function (value) {
                                    return value;
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    },
                    layout: {
                        padding: {
                            bottom: 10,
                            left: 3,
                            right: 3
                        }
                    }
                }
            });
        }

        // Crear gráficos iniciales con etiquetas de ejes
        let tempChart, humChart, precChart, radChart;

        // Función para actualizar los ejes de las gráficas
        function updateChartAxes() {
            // Destruir gráficos existentes
            if (tempChart) tempChart.destroy();
            if (humChart) humChart.destroy();
            if (precChart) precChart.destroy();
            if (radChart) radChart.destroy();
            
            // Crear nuevos gráficos con etiquetas traducidas
            tempChart = createChart(
                tempCtx, 
                variableColors.airTC, 
                translations[currentLang].chartTempTitle, 
                translations[currentLang].axisX, 
                translations[currentLang].axisY
            );
            
            humChart = createChart(
                humCtx, 
                variableColors.Rh, 
                translations[currentLang].chartHumTitle, 
                translations[currentLang].axisX, 
                translations[currentLang].axisY
            );
            
            precChart = createChart(
                precCtx, 
                variableColors.lluvia, 
                translations[currentLang].chartPrecTitle, 
                translations[currentLang].axisX, 
                translations[currentLang].axisY
            );
            
            radChart = createChart(
                radCtx, 
                variableColors.slrw, 
                translations[currentLang].chartRadTitle, 
                translations[currentLang].axisX, 
                translations[currentLang].axisY
            );
            
            // Actualizar datos en los gráficos
            updateChart();
        }

        let chartData = [];
        let selectedDate = new Date();
        selectedDate.setHours(0, 0, 0, 0); // Fecha predeterminada: hoy

        // Actualizar título de la gráfica
        function updateChartTitle() {
            const dateStr = displayLocalDate(selectedDate);
            document.getElementById('chart-title').textContent = `${translations[currentLang].chartTitle}: ${dateStr}`;
        }

        // Actualizar tarjetas de datos
        async function updateDataCards() {
            try {
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    .order('tiempo', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const latestData = data[0];

                    document.querySelector('.card-dark[data-var="airTC"] .main-value').textContent = latestData.airTC.toFixed(2) + "°C";
                    document.querySelector('.card-dark[data-var="Rh"] .main-value').textContent = latestData.Rh.toFixed(2) + "%";
                    document.querySelector('.card-dark[data-var="lluvia"] .main-value').textContent = latestData.lluvia.toFixed(2) + " mm";
                    document.querySelector('.card-dark[data-var="slrw"] .main-value').textContent = latestData.slrw.toFixed(2) + " W/m²";

                    document.querySelectorAll('.card-time').forEach(el => {
                        el.textContent = latestData.hora ? latestData.hora.substring(0, 5) : '--:--';
                    });

                    updateIconAnimations(latestData);

                    const now = new Date();
                    document.getElementById('time-indicator').textContent =
                        `${translations[currentLang].timeIndicator} ${now.toLocaleTimeString('es-EC')}`;
                }
            } catch (error) {
                console.error('Error al obtener datos:', error);
            }
        }

        // Actualizar animaciones de íconos
        function updateIconAnimations(data) {
            const tempIcon = document.querySelector('.card-dark[data-var="airTC"] .icon');
            const tempSpeed = 2 - (data.airTC / 40);
            tempIcon.style.animation = `pulse ${Math.max(0.5, Math.min(2, tempSpeed))}s infinite`;

            const humIcon = document.querySelector('.card-dark[data-var="Rh"] .icon');
            const humSpeed = 3 - (data.Rh / 50);
            humIcon.style.animation = `droplet ${Math.max(1, Math.min(3, humSpeed))}s infinite`;

            const precIcon = document.querySelector('.card-dark[data-var="lluvia"] .icon');
            let precSpeed = 3;
            if (data.lluvia > 0) {
                precSpeed = 3 - (data.lluvia / 5);
                precIcon.style.animation = `rain ${Math.max(0.8, Math.min(3, precSpeed))}s infinite`;
            }

            const radIcon = document.querySelector('.card-dark[data-var="slrw"] .icon');
            const radSpeed = 3 - (data.slrw / 500);
            radIcon.style.animation = `shine ${Math.max(1, Math.min(3, radSpeed))}s infinite`;
        }

        // MEJORA: Actualizar gráfica con manejo de zona horaria
        async function updateChart() {
            updateChartTitle();

            try {
                const offset = new Date().getTimezoneOffset(); // Ecuador = 300

                // --- RANGO 1: 00:00 a 11:59 ---
                const start1 = new Date(selectedDate);
                start1.setHours(0, 0, 0, 0);

                const end1 = new Date(selectedDate);
                end1.setHours(12, 0, 0, 0);

                // --- RANGO 2: 12:00 a 23:59 ---
                const start2 = new Date(selectedDate);
                start2.setHours(12, 0, 0, 0);

                const end2 = new Date(selectedDate);
                end2.setDate(end2.getDate() + 1); // día siguiente
                end2.setHours(0, 0, 0, 0);

                // Convertir todo a UTC
                const startUTC1 = new Date(start1.getTime() - offset * 60000);
                const endUTC1 = new Date(end1.getTime() - offset * 60000);
                const startUTC2 = new Date(start2.getTime() - offset * 60000);
                const endUTC2 = new Date(end2.getTime() - offset * 60000);

                // --- CONSULTA 1 ---
                const { data: data1, error: error1 } = await supabase
                    .from(TABLE_NAME)
                    .select('tiempo, fecha, hora, airTC, Rh, lluvia, slrw')
                    .gte('tiempo', startUTC1.toISOString())
                    .lt('tiempo', endUTC1.toISOString())
                    .order('tiempo', { ascending: true });

                if (error1) throw error1;

                // --- CONSULTA 2 ---
                const { data: data2, error: error2 } = await supabase
                    .from(TABLE_NAME)
                    .select('tiempo, fecha, hora, airTC, Rh, lluvia, slrw')
                    .gte('tiempo', startUTC2.toISOString())
                    .lt('tiempo', endUTC2.toISOString())
                    .order('tiempo', { ascending: true });

                if (error2) throw error2;

                // Unir resultados
                const chartData = [...(data1 || []), ...(data2 || [])];

                // --- PROCESAR POR HORA ---
                const tempData = Array(24).fill(null);
                const humData = Array(24).fill(null);
                const precData = Array(24).fill(null);
                const radData = Array(24).fill(null);

                // Array de 24 cubos, cada cubo es un array de registros para esa hora
                const hourlyBuckets = Array(24).fill().map(() => []);

                chartData.forEach(record => {
                    try {
                        // Extraer hora de record.hora (formato HH:MM:SS)
                        const hourPart = record.hora.split(':')[0];
                        const hour = parseInt(hourPart, 10);
                        if (hour >= 0 && hour < 24) {
                            hourlyBuckets[hour].push(record);
                        }
                    } catch (e) {
                        console.warn("Hora inválida:", record.hora);
                    }
                });

                for (let hour = 0; hour < 24; hour++) {
                    const records = hourlyBuckets[hour];
                    if (records.length > 0) {
                        // Temperatura: promedio
                        tempData[hour] = records.reduce((sum, r) => sum + r.airTC, 0) / records.length;

                        // Humedad: promedio
                        humData[hour] = records.reduce((sum, r) => sum + r.Rh, 0) / records.length;

                        // Precipitación: SUMA (no promedio)
                        precData[hour] = records.reduce((sum, r) => sum + r.lluvia, 0);

                        // Radiación: promedio
                        radData[hour] = records.reduce((sum, r) => sum + r.slrw, 0) / records.length;
                    }
                }

                // --- ACTUALIZAR GRÁFICOS ---
                updateSingleChart(tempChart, tempData);
                updateSingleChart(humChart, humData);
                updateSingleChart(precChart, precData);
                updateSingleChart(radChart, radData);

                // --- ESTADÍSTICAS ---
                updateChartStatsForVariable('airTC', chartData, 'Temp');
                updateChartStatsForVariable('Rh', chartData, 'Hum');
                updateChartStatsForVariable('lluvia', chartData, 'Prec');
                updateChartStatsForVariable('slrw', chartData, 'Rad');

                // --- HORA DE ACTUALIZACIÓN ---
                const now = new Date();
                document.getElementById('time-indicator').textContent =
                    `${translations[currentLang].timeIndicator} ${now.toLocaleTimeString('es-EC')}`;

            } catch (error) {
                console.error('Error al actualizar gráfico:', error);
            }
        }

        function updateSingleChart(chart, data) {
            chart.data.datasets[0].data = data;
            chart.update();
        }

        // MEJORA: Calcular estadísticas diarias correctas
        function updateChartStatsForVariable(variable, data, suffix) {
            if (!data || data.length === 0) {
                document.getElementById(`maxValue${suffix}`).textContent = '--';
                document.getElementById(`minValue${suffix}`).textContent = '--';
                document.getElementById(`avgValue${suffix}`).textContent = '--';
                document.getElementById(`maxDate${suffix}`).textContent = '--:--';
                document.getElementById(`minDate${suffix}`).textContent = '--:--';
                if (suffix === 'Prec') {
                    document.getElementById(`totalValue${suffix}`).textContent = '--';
                }
                return;
            }

            // Calcular valores para todo el día
            const values = data.map(d => d[variable]);
            const max = Math.max(...values);
            const min = Math.min(...values);
            const avg = values.reduce((a, b) => a + b, 0) / values.length;

            // Encontrar registros para max y min
            const maxRecord = data.find(d => d[variable] === max);
            const minRecord = data.find(d => d[variable] === min);

            document.getElementById(`maxValue${suffix}`).textContent = max.toFixed(2);
            document.getElementById(`minValue${suffix}`).textContent = min.toFixed(2);
            document.getElementById(`avgValue${suffix}`).textContent = avg.toFixed(2);

            // Formatear solo la hora (HH:MM) para max y min
            const formatTime = (record) => {
                if (!record || !record.hora) return '--:--';
                // Tomar solo los primeros 5 caracteres (HH:MM)
                return record.hora.substring(0, 5);
            };

            document.getElementById(`maxDate${suffix}`).textContent = formatTime(maxRecord);
            document.getElementById(`minDate${suffix}`).textContent = formatTime(minRecord);

            // Calcular suma total solo para precipitación
            if (suffix === 'Prec') {
                const total = values.reduce((a, b) => a + b, 0);
                document.getElementById(`totalValue${suffix}`).textContent = total.toFixed(2) + " mm";
            }
        }

        // MEJORA: Función para agrupar datos por intervalo exacto
        function groupDataByInterval(data, interval) {
            if (interval === '1min') return data;

            // Mapa para agrupar por tiempo redondeado
            const groupedData = {};

            data.forEach(record => {
                const date = new Date(record.tiempo);
                let roundedTime;

                if (interval === 'daily') {
                    // Agrupar por fecha directamente (sin hora)
                    roundedTime = record.fecha; // agrupación 100% confiable por campo fecha
                } else {
                    // Calcular minutos totales
                    const totalMinutes = date.getHours() * 60 + date.getMinutes();
                    let intervalMinutes;

                    switch (interval) {
                        case '5min': intervalMinutes = 5; break;
                        case '15min': intervalMinutes = 15; break;
                        case '30min': intervalMinutes = 30; break;
                        case '60min': intervalMinutes = 60; break;
                        default: intervalMinutes = 60;
                    }

                    // Redondear al intervalo más cercano (hacia abajo)
                    const roundedMinutes = Math.floor(totalMinutes / intervalMinutes) * intervalMinutes;
                    const roundedHours = Math.floor(roundedMinutes / 60);
                    const finalMinutes = roundedMinutes % 60;

                    roundedTime = new Date(
                        date.getFullYear(),
                        date.getMonth(),
                        date.getDate(),
                        roundedHours,
                        finalMinutes,
                        0,
                        0
                    ).toISOString();
                }

                if (!groupedData[roundedTime]) {
                    groupedData[roundedTime] = [];
                }
                groupedData[roundedTime].push(record);
            });

            // Procesar cada grupo
            const result = [];
            for (const time in groupedData) {
                const group = groupedData[time];
                const aggregated = aggregateGroup(group);

                if (group.length > 0) {
                    // Usar el primer registro como base
                    const firstRecord = group[0];
                    result.push({
                        tiempo: interval === 'daily' ? "00:00:00" : firstRecord.time,
                        fecha: firstRecord.fecha,
                        hora: interval === 'daily' ? "00:00:00" : firstRecord.hora,
                        airTC: aggregated.airTC,
                        lluvia: aggregated.lluvia,
                        Rh: aggregated.Rh,
                        slrw: aggregated.slrw
                    });
                }
            }

            return result;
        }

        // Función para agregar datos del grupo
        function aggregateGroup(group) {
            return {
                airTC: calculateAverage(group, 'airTC'),
                lluvia: calculateSum(group, 'lluvia'),
                Rh: calculateAverage(group, 'Rh'),
                slrw: calculateAverage(group, 'slrw')
            };
        }

        // Calcular promedio
        function calculateAverage(data, key) {
            const values = data.map(d => d[key]).filter(val => val !== null);
            return values.length ? (values.reduce((a, b) => a + b, 0) / values.length) : 0;
        }

        // Calcular suma
        function calculateSum(data, key) {
            return data.reduce((sum, d) => sum + (d[key] || 0), 0);
        }

        // MEJORA: Función para descargar datos por rango de fechas
        const downloadRangeData = async () => {
            const btn = document.getElementById('downloadRangeBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-sync-alt spin"></i> ' + translations[currentLang].downloadBtn;
            btn.disabled = true;

            const dateWarning = document.getElementById('dateWarning');
            dateWarning.classList.add('show');

            try {
                // Obtener fechas seleccionadas
                const startDateValue = document.getElementById('startDate').value;
                const endDateValue = document.getElementById('endDate').value;

                // Validar fechas
                if (!startDateValue || !endDateValue) {
                    throw new Error(translations[currentLang].dateWarningText);
                }

                if (startDateValue > endDateValue) {
                    throw new Error(translations[currentLang].dateWarningText);
                }

                // Validar que las fechas no sean futuras
                const today = new Date();
                const todayStr = formatLocalDate(today);

                if (startDateValue > todayStr || endDateValue > todayStr) {
                    throw new Error(translations[currentLang].dateWarningText);
                }

                // Validar que las fechas no sean anteriores al 9 de julio de 2025
                if (startDateValue < '2025-07-09' || endDateValue < '2025-07-09') {
                    throw new Error(translations[currentLang].dataNote);
                }

                // Obtener intervalo seleccionado para descarga
                const interval = document.getElementById('downloadIntervalSelect').value;
                const fileFormat = document.getElementById('fileFormatSelect').value;

                // Obtener todos los datos para el rango de fechas
                let allData = [];
                let page = 0;
                const pageSize = 1000;
                let hasMoreData = true;

                while (hasMoreData) {
                    const { data, error } = await supabase
                        .from(TABLE_NAME)
                        .select('tiempo, fecha, hora, airTC, lluvia, Rh, slrw')
                        .gte('fecha', startDateValue)
                        .lte('fecha', endDateValue)
                        .order('fecha', { ascending: true })
                        .order('hora', { ascending: true })
                        .range(page * pageSize, (page + 1) * pageSize - 1);

                    if (error) throw error;

                    if (!data || data.length === 0) break;

                    allData = [...allData, ...data];

                    if (data.length < pageSize) {
                        hasMoreData = false;
                    } else {
                        page++;
                    }
                }

                if (allData.length === 0) {
                    return alert(translations[currentLang].dataNote);
                }

                // Agrupar datos según el intervalo seleccionado
                let processedData;
                if (interval === '1min') {
                    processedData = allData;
                } else {
                    processedData = groupDataByInterval(allData, interval);
                }

                // Ordenar de más reciente a más antiguo
                processedData = processedData.reverse();

                // Preparar datos para exportación
                const headers = [
                    'Fecha Sensor', 'Hora Sensor',
                    'Temperatura (°C)', 'Precipitación (mm)', 'Humedad (%)', 'Radiación (W/m²)'
                ];

                const rows = processedData.map(d => [
                    d.fecha,
                    d.hora,
                    d.airTC ? d.airTC.toFixed(2) : '0.00',
                    d.lluvia ? d.lluvia.toFixed(2) : '0.00',
                    d.Rh ? d.Rh.toFixed(2) : '0.00',
                    d.slrw ? d.slrw.toFixed(2) : '0.00'
                ]);

                // Crear hoja de cálculo
                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);

                // Formatear encabezados
                headers.forEach((header, index) => {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: index });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = { font: { bold: true } };
                    }
                });

                // Ajustar ancho de columnas
                ws['!cols'] = [
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 18 }
                ];

                // Crear y descargar archivo
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Datos Meteorológicos');

                // Nombre del archivo
                const fileName = `Dados_Meteorológicos_Tapichalaca_${startDateValue}_a_${endDateValue}_${interval}`;

                if (fileFormat === 'xlsx') {
                    XLSX.writeFile(wb, `${fileName}.xlsx`);
                } else {
                    // Exportar como CSV
                    const csv = XLSX.utils.sheet_to_csv(ws);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `${fileName}.csv`;
                    link.click();
                }

            } catch (error) {
                alert('Error al descargar: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                setTimeout(() => dateWarning.classList.remove('show'), 5000);
            }
        };

        // Event listeners
        document.getElementById('downloadRangeBtn').addEventListener('click', downloadRangeData);

        document.getElementById('refreshAllBtn').addEventListener('click', async () => {
            const btn = document.getElementById('refreshAllBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-sync-alt spin"></i> ' + translations[currentLang].refreshBtn;

            try {
                await updateDataCards();
                await updateChart();
            } catch (error) {
                console.error('Error al actualizar todo:', error);
            } finally {
                btn.innerHTML = originalText;
            }
        });

        // Event listener para el selector de fecha de la gráfica
        document.getElementById('chartDatePicker').addEventListener('change', function () {
            const dateString = this.value;
            if (!dateString) return;

            const [year, month, day] = dateString.split('-').map(Number);
            selectedDate = new Date(year, month - 1, day);

            updateChart();
        });

        // Event listener para el botón de idioma
        document.getElementById('languageButton').addEventListener('click', changeLanguage);

        async function initApp() {
            // Inicializar fechas
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayStr = formatLocalDate(today);

            document.getElementById('startDate').value = '2025-07-09';
            document.getElementById('endDate').value = todayStr;
            document.getElementById('chartDatePicker').value = todayStr;

            document.getElementById('startDate').min = '2025-07-09';
            document.getElementById('startDate').max = todayStr;
            document.getElementById('endDate').min = '2025-07-09';
            document.getElementById('endDate').max = todayStr;
            document.getElementById('chartDatePicker').min = '2025-07-09';
            document.getElementById('chartDatePicker').max = todayStr;

            // Usar la fecha actual como predeterminada
            selectedDate = today;

            // Inicializar gráficos con ejes
            updateChartAxes();
            
            // Inicializar selector de formato
            updateFileFormatSelect();
            
            updateChartTitle();
            await updateDataCards();
            await updateChart();
            setInterval(updateDataCards, 60000);
            setInterval(updateChart, 300000);
        }

        initApp();

        const style = document.createElement('style');
        style.innerHTML = `
            .spin {
                animation: spin 1s linear infinite;
                display: inline-block;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>
